:chapterNumber: 5
:chapterId: chapter-05
:sourceDir: ./examples
:httpRoot: http://localhost:3000
:sourceSample: cow.js
:nodeCurrentVersion: v10
:npmCurrentVersion: v6
:lodashVersion: 4.17.10
:mochaVersion: 5.2.0
:serveVersion: 7.2.0
:microVersion: 9.3.2
:npmvX: 6.1.0
:sectnums:
:revdate: {docdate}
:imagesdir: {indir}
ifdef::env[]
:imagesdir: .
endif::[]

= Jouer avec npm

TBD.

====
.Sommaire
- Cr√©er un fichier `package.json`
- Installer un module npm
- Aller et venir entre les versions d'un module npm
- Outiller un projet avec les scripts npm
- Publier un module sur le registre npm
- Questions et myst√®res autour de npm
====

[abstract]
--
TBD.
--

include::../resources/tip-versions.adoc[]
include::../resources/tip-examples.adoc[]

Le mot _npm_ correspond √† trois concepts diff√©rents que nous aborderons
tout au long de ce chapitre :

- l'*ex√©cutable* `npm` ‚Äî un programme √©crit en JavaScript ;
- le *registre* _npm_ ‚Äî une plate-forme de distribution de modules ;
- un *module* _npm_ ‚Äî en g√©n√©ral install√© depuis le registre et utilisable avec la fonction `require()`.

Je pr√©ciserai toujours si l'utilisation de _npm_ fait r√©f√©rence
√† l'_ex√©cutable_, au _registre_ ou √† un _module_.

L'ex√©cutable `npm` est install√© par d√©faut avec l'ex√©cutable `node`.
Nous pouvons v√©rifier la version install√©e en ouvrant un terminal
et en √©crivant la commande suivante :

[subs="+attributes"]
----
$ npm --version
{npmvX}
----

Si un message s'affiche en indiquant que `npm` n'est pas un programme reconnu,
veuillez vous r√©f√©rer au <<../chapter-02/index.adoc,chapitre 2>> et
v√©rifier que Node {nodeCurrentVersion} est bien install√©.


[[cli]]
== Cr√©er un fichier `package.json`

La pr√©sence d'un fichier `package.json` est n√©cessaire pour utiliser npm
dans un projet.
La commande `npm init` g√©n√®re un tel fichier en nous posant des questions.
Nous irons plus vite en utilisant l'option `--yes` :

----
$ npm init --yes
----

Le fichier `package.json` sera cr√©√© avec le contenu suivant :

----
{
  "name": "<nom du r√©pertoire>",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}
----

Si le fichier existait d√©j√†, la copie existante sera pr√©serv√©e et affich√©e
√† l'√©cran.

Nous allons ignorer le contenu du fichier dans un premier temps
afin de nous focaliser sur l'op√©ration la plus importante et la plus
fr√©quemment utilis√©e :
l'installation de modules npm avec la commande `npm install`.

[[modules]]
== Installer des modules npm

Le m√©canisme de modules est document√© dans
le <<../chapter-04/index.adoc#,chapitre 4>>.
La fonction `require()` charge nos propres modules mais aussi
les modules de base, propos√©s par Node.
Les modules npm sont des *modules compl√©mentaires et t√©l√©chargeables* √† l'aide
de l'ex√©cutable `npm`.

Cette section va nous aider √† comprendre ce qu'il se passe sous le capot
pendant les phases d'installation et de d√©sinstallation des modules npm.

=== Depuis le registre npm

Le registre npm ([URL]#https://npmjs.com#) est l'h√©bergement principal
des modules JavaScript.

La commande `npm install` s'utilise directement quand nous connaissons d√©j√†
le nom d'un module √† installer,
par exemple le module _cowsay_ ([URL]#https://npmjs.com/cowsay#) :

----
$ npm install cowsay
+ cowsay@1.3.0
added 10 packages from 3 contributors in 1.667s
found 0 vulnerabilities
----

Le module est install√© et pr√™t √† √™tre inclus dans un script.
Nous pouvons aussi constater que le champ `dependencies` est apparu
dans le fichier `package.json` :

[source,json]
.package.json
----
{
  ...
  "dependencies": {
    "cowsay": "^1.3.0"
  }
}
----

L'ex√©cutable `npm` tient les comptes des modules install√©s √† notre demande.
√áa nous sera utile pour <<install,installer les modules sur un autre ordinateur>>.
Nous reviendrons plus tard sur la notation des versions
‚Äî on en reparlera sous le nom de _versions s√©mantiques_ (_Semantic Versionning_).

[source%interactive,javascript]
.cow.js
----
include::{sourceDir}/cow.js[]
----

Nous pouvons remarquer que l'inclusion d'un module npm est identique
√† celle d'un <<../chapter-04/index.adoc#modules-builtin,module de base>>. +
Regardons le r√©sultat sans plus tarder :

----
$ node cow.js
___________
< Bonjour ! >
-----------
       \   ^__^
        \  (oo)\_______
           (__)\       )\/\
               ||----w |
----

L'utilisation d'un module npm nous a permis d'utiliser du code sans avoir √† le
cr√©er alors qu'il n'√©tait pas fourni par la plate-forme Node.

Maintenant que nous savons installer un module npm, nous pouvons en chercher
d'autres et comprendre comment les utiliser.

[NOTE]
.[RemarquePreTitre]#Question# O√π sont stock√©s les modules npm ?
====
Les modules npm et leurs d√©pendances sont stock√©s dans un r√©pertoire
`node_modules`.
Ce r√©pertoire est situ√© au m√™me niveau que le fichier `package.json`.
====


[NOTE]
.[RemarquePreTitre]#Sous le cap√¥t# Ce que fait l'ex√©cutable `npm` pendant l'installation
====
L'ex√©cutable `npm` effectue un bon nombre d'actions apr√®s avoir
saisi la commande `npm install cowsay` :

1. il interroge le registre _npmjs.com_ pour obtenir des informations sur le module demand√© ;
2. il d√©termine que `1.3.0` est la version la plus r√©cente ;
3. il t√©l√©charge une archive compress√©e (`.tar.gz`) qui contient tous les fichiers de la version `1.3.0` ;
4. l'archive est d√©compress√©e dans le r√©pertoire `node_modules` ;
5. les d√©pendances sont elles aussi t√©l√©charg√©es puis d√©compress√©es dans le r√©pertoire `node_modules` ;
6. le module `cowsay` est inscrit dans le fichier `package.json`.
====


[[registry]]
=== Trouver son bonheur dans le registre npm

Le _registre npm_ ([URL]#https://npmjs.com#) fourmille de modules
‚Äî de simples fonctions, des librairies ou des _frameworks_ complets.
Ils couvrent un spectre d'usages allant de l'acc√®s aux bases de donn√©es,
√† des frameworks web, √† des outils frontend, des utilitaires de test,
de compression de donn√©es, du paiement bancaire, des frameworks mobiles, etc.

Essayons-nous √† chercher une librairie qui puisse nous connecter √† une
base de donn√©es MySQL ou MariaDB.
Tapez `mysql` dans le champ de recherche du registre npm ou saisissez
directement l'URL menant aux r√©sultats de cette recherche en vous
rendant sur [URL]#https://npmjs.com/search?q=mysql# :

.Extrait des r√©sultats d'une recherche de modules npm avec le mot-cl√© _mysql_.
image::images/npm-registry-search.png[]

Les r√©sultats sont tri√©s par pertinence ‚Äî un m√©lange entre popularit√©,
qualit√© et maintenance des projets.

Je trouve qu'il est difficile de d√©cider uniquement en regardant la liste.
J'ai tendance √† ouvrir un onglet par module pour lire leur documentation.

Prenons le cas du module _mysql2_ ([URL]#https://npmjs.com/mysql2#) justement :

.Extrait de la page consacr√©e au module npm _mysql2_.
image::images/npm-package-mysql2.png[]

Plusieurs √©l√©ments de cette page tendent √† me rassurer
et m'aident √† juger de la robustesse de ce module npm :

- les badges qui affichent le statut d'ex√©cution des tests ;
- une introduction de *documentation claire et concise* ;
- un *nombre de t√©l√©chargements* en progr√®s r√©guliers ;
- il s'utilise avec des promesses ;
- le nombre important de modules d√©pendants ;
- *je reconnais une autrice* qui contribue du code de qualit√©.

J'ai un doute quand je lis _108 issues_ et _13 pull requests_.
Dans ce cas-l√† je me dis que les personnes qui maintiennent le projet ne sont
pas forc√©ment tr√®s r√©actives.

Cependant, il y a suffisamment d'indicateurs au vert pour l'installer √† coup de
`npm install mysql2` puis √† l'essayer dans un script.

Le module _mysql-libmysqlclient_ ([URL]#https://npmjs.com/mysql-libmysqlclient#)
ne me fait pas du tout le m√™me effet :

.Extrait de la page consacr√©e au module npm _mysql-libmysqlclient_.
image::images/npm-package-mysql-libmysqlclient.png[]

La page du module ne met pas d'exemple simple √† comprendre et fait r√©f√©rence
√† des versions de Node ant√©diluviennes.
Rien n'indique qu'il ne peut pas fonctionner avec Node {nodeCurrentVersion}
mais la pr√©sence du mot _binding_ m'√©voque que l'installation du module
compile un programme pour parler avec un programme √©crit dans un autre langage
‚Äî en l'occurrence, _libmysqlclient_.

Point positif : il n'y a que 14 _issues_ GitHub.
C'est peu mais l'une d'entre elle est intitul√©e
¬´ __Does not work with any modern version of Node.js__ ¬ª.
√áa confirme les doutes du paragraphe pr√©c√©dent :
c'est suffisant pour que je passe mon chemin.

En continuant plus loin dans la liste des r√©sultats de recherche,
je suis tomb√© sur le module npm nomm√© _falchion_ :

.Extrait de la page consacr√©e au module npm _falchion_.
image::images/npm-package-falchion.png[]

Il n'y a qu'une seule version du module, qui date de quatre ann√©es
avec une documentation qui tient sur une ligne. +
Il y a tr√®s peu de chances que nous puissions en faire quelque chose.

Voici au final ce que j'estime √™tre le plus important pour me faire
une id√©e d'un module et d√©cider de l'installer ou non :

- pr√©sence d'une *documentation* ‚Äî je peux me faire une id√©e des fonctionnalit√©s
et de la complexit√© d'utilisation du module ;
- des badges d'*int√©gration continue* ‚Äî je sais ainsi qu'il y a des tests
unitaires qui sont ex√©cut√©s automatiquement avant que le module soit publi√© ;
- le nombre de *t√©l√©chargements* ‚Äî je sais si d'autres personnes s'en servent
en esp√©rant qu'ils remontent les probl√®mes rencontr√©s ;
- le nombre de *versions* ‚Äî √ßa me donne une id√©e de la maturit√© du projet
et de la r√©activit√© aux demandes de la communaut√©.

Ce sont des *crit√®res subjectifs*.
Un module peut √™tre populaire par anciennet√© alors qu'il existe des alternatives,
plus l√©g√®res ou plus simple d'utilisation.
C'est le cas du module _moment.js_ qui est plus populaire que _date-fns_
‚Äî alors que je pr√©f√®re ce dernier.

Il y a aussi des modules pour lesquels j'ai une confiance quasi-aveugle.
Ils sont publi√©s par les personnes pr√©sentes dans cette liste non-exhaustive :

[format="csv"]
.Auteurs et autrices de modules npm √† suivre
|===
dougwilson, [URL]#https://npmjs.com/~dougwilson#
feross, [URL]#https://npmjs.com/~feross#
fgribreau, [URL]#https://npmjs.com/~fgribreau#
iarna, [URL]#https://npmjs.com/~iarna#
isaacs, [URL]#https://npmjs.com/~isaacs#
jdalton, [URL]#https://github.com/jdalton#
jshttp, [URL]#https://github.com/jshttp#
mbostock, [URL]#https://npmjs.com/~mbostock#
nodejitsu, [URL]#https://github.com/nodejitsu#
rwaldron, [URL]#https://npmjs.com/~rwaldron#
sindresorhus, [URL]#https://npmjs.com/~sindresorhus#
substack, [URL]#https://npmjs.com/~substack#
zkat, [URL]#https://npmjs.com/~zkat#
|===

[TIP]
.[RemarquePreTitre]#Pratique# S√©lection de modules npm
====
J'ai compil√© une liste de modules utiles pour mieux d√©marrer
dans vos projets.

Vous la trouverez en <<../appendix-a/index.adoc#,annexe A>>.
====

[[uninstall]]
=== D√©sinstaller un module

Nous sommes emmen√©s √† remplacer un module par un autre ou √† changer d'avis
sur la n√©cessit√© d'un module.
L'utilisation de la commande `npm uninstall` nous aidera √† supprimer
les fichiers du module en toute s√©curit√© puis √† le retirer de la liste
des d√©pendances du fichier `package.json`.

----
$ npm un cowsay
removed 10 packages in 1.963s
found 0 vulnerabilities
----

Le module _cowsay_ n'est plus install√©.
Que se passe-t-il si nous ex√©cutons √† nouveau un des premiers exemples de cette
section ?

----
$ node cow.js
internal/modules/cjs/loader.js:596
    throw err;
    ^

Error: Cannot find module 'cowsay'
----

Une nouvelle erreur se produit sous nos yeux.
Le chargement du module _cowsay_ a √©chou√© car Node n'arrive pas √† le trouver
‚Äî et c'est normal.

Nous devons √† nouveau lancer la commande `npm install cowsay`
pour que le script fonctionne √† nouveau.


[[install]]
=== Depuis un fichier `package.json`

Jusqu'√† pr√©sent, nous avons install√© des modules car nous les ajoutions
au projet.
La proc√©dure est l√©g√®rement diff√©rente si nous avons √† installer √† nouveau
des d√©pendances d√©j√† list√©es dans le champ `dependencies` du fichier
`package.json`.

Pour en avoir le c≈ìur net, pla√ßons-nous dans le r√©pertoire qui contient
le fichier `package.json` et supprimons le r√©pertoire `node_modules`
qui contient les d√©pendances d√©j√† install√©es.
Ex√©cutons ensuite la commande `npm install` sans autre argument :

----
$ rm -rf node_modules
$ npm install
added 10 packages from 3 contributors in 2.276s
found 0 vulnerabilities
----

Au final, la commande `npm install` est s'utilise quand
nous r√©cup√©rons du code avec Git pour la premi√®re fois ou apr√®s une mise √† jour,
par exemple avec `git pull`.

L'ex√©cutable `npm` v√©rifie toujours que les modules npm install√©s dans
le r√©pertoire `node_modules` correspondent bien √† ceux qui sont list√©s
dans le fichier `package.json`.
Il installe, met √† jour et retire les modules npm en fonction de ce
qui est n√©cessaire.

[NOTE]
.[RemarquePreTitre]#Remarque# D√©pendances de d√©veloppement
====
La commande `npm install` a √©galement pour effet d'installer
les <<install.dev,d√©pendances de d√©veloppement>> list√©es dans le fichier
`package.json`.
====

[[install.version]]
=== Sp√©cifier une version

L'ex√©cutable `npm` installe la derni√®re version d'un module par d√©faut.
Nous avons la libert√© d'en installer d'autres qui sont ant√©rieures.
C'est pratique quand des modules npm arr√™tent de supporter
des navigateurs web ou des versions de Node alors que nous les utilisons encore.

Nous allons utiliser le module _lodash_ ([URL]#https://npmjs.com/lodash#)
pour illustrer nos all√©es et venues entre diff√©rentes versions.
√Ä l'heure o√π j'√©cris ces lignes, la version la plus r√©cente sur le registre npm
est la `{lodashVersion}`.
C'est ce que rapporte le r√©sultat de la commande `npm install lodash` :

[subs="+attributes"]
----
$ npm install lodash
+ lodash@{lodashVersion}
----

L'utilisation du caract√®re `@` indique le num√©ro de version souhait√© √†
l'ex√©cutable `npm` :

----
$ npm install lodash@3.0.0
+ lodash@3.0.0
----

Nous avons install√© une version pr√©cise mais il y a surement des mises √† jour
qui ont suivi pour corriger des bugs.
Le probl√®me est qu'√† ce stade, nous ne connaissons pas le num√©ro de version
√† sp√©cifier.
Id√©alement, je pr√©f√®rerais installer la version la plus r√©cente de la s√©rie 3.
Il se trouve que l'ex√©cutable `npm` sait le faire pour nous et sans effort :

----
$ npm install lodash@3
+ lodash@<i>3.10.1</i>
----

Nous pouvons faire la m√™me chose avec la version
la plus r√©cente de la s√©rie 3 et de la s√©rie 2.2 :

----
$ npm install lodash@3
+ lodash@3.10.1
$ npm install lodash@2.2
+ lodash@2.2.1
----

[TIP]
.[RemarquePreTitre]#Pratique# Conna√Ætre toutes les versions d'un module
====
La <<view,commande `npm view`>> retourne les informations d'un module npm
directement depuis notre terminal.
Elle retourne toutes les versions publi√©es avec l'argument `versions` :

----
$ npm view lodash <i>versions</i>
[ '0.1.0',
  '0.2.0',
  ...
  '1.0.0',
  '1.0.1',
  '1.0.2',
  ... ]
----
====

Revenons √† la version la plus r√©cente en r√©utilisant la
<<install,commande d'installation>> abord√©e auparavant :

----
$ npm install lodash
+ lodash@2.4.2
----

Quelque chose d'inattendu s'est produit : la version la plus r√©cente
de la s√©rie 2 a √©t√© install√©e au lieu de la version {lodashVersion}. +
Nous trouverons un √©l√©ment de r√©ponse dans le fichier `package.json` :

[source,json,subs="-specialchars"]
.package.json
----
{
  ...
  "dependencies": {
    "cowsay": "^1.3.0",
    "lodash": "<i>^2.4.2</i>"
  }
}
----

L'ex√©cutable `npm` respecte la version pr√©cis√©e dans le fichier `package.json`
si elle n'est pas pr√©cis√©e dans la commande.
Si la d√©pendance n'est pas list√©e, alors l'ex√©cutable `npm` installe la version
la plus r√©cente.

L'√©tiquette `latest` explicite notre envie d'installer la version
la plus r√©cente et sans tenir compte du fichier `package.json` :

[subs="+attributes"]
----
$ npm install lodash@<i>latest</i>
+ lodash@{lodashVersion}
----

Nous sommes d√©sormais en mesure de choisir entre diff√©rentes versions
d'un module et de mani√®re plus ou moins fine. +
Nous prendrons le temps d'explorer le m√©canisme de num√©rotation des versions
dans la section suivante afin de mieux comprendre ce qui est renseign√©
dans le fichier `package.json`.

[TIP]
.[RemarquePreTitre]#Pratique# Conna√Ætre les √©tiquettes d'un module
====
La <<view,commande `npm view`>> va √† nouveau nous aider.
Elle retourne toutes les versions publi√©es avec l'argument `dist-tags` :

[subs="+attributes"]
----
$ npm view lodash dist-tags
{ <i>latest</i>: '{lodashVersion}' }
----

Ce m√©canisme d'√©tiquette sert de raccourci pour associer un num√©ro de version
(qui change) √† un intitul√© (qui reste dans le temps).
====


[[semver]]
=== Comprendre les num√©ros de versions (_Semantic Versioning_)

Les num√©ros de versions ont √©t√© utilis√©es de deux mani√®res dans les
sections pr√©c√©dentes : avec l'ex√©cutable `npm` et en observant la liste
de d√©pendances dans le fichier `package.json`.

L'ex√©cutable `npm` d√©coupe un num√©ro de version en trois parties :
_majeur_, _mineur_ et _patch_.
Pour le num√©ro de version `1.2.3`, `1` est le num√©ro de version majeur,
`2` est le num√©ro de version mineur tandis que  `3` est le num√©ro de version patch.

√âtudions la mise √† jour de `lodash@2.2.0` :

- vers `lodash@2.2.1` : mise √† jour patch ‚Äî des bugs sont corrig√©s ;
- vers `lodash@2.4.2` : mise √† jour mineure ‚Äî des fonctionnalit√©s sont ajout√©es,
corrig√©es ou modifi√©es et ce, sans affecter notre code ;
- vers `lodash@{lodashVersion}` : mise √† jour majeure ‚Äî des fonctionnalit√©s ont
√©t√© modifi√©es, remani√©es ou supprim√©es et peuvent casser notre code qui repose dessus.

Une mise √† jour majeure demande de lire attentivement la documentation du module
pour comprendre le volume de travail √† fournir avant de monter en version.
La mise √† jour mineure peut occasionnellement demander du travail selon
interpr√©tation des d√©veloppeurs de modules npm.

[format="csv", options="header", cols="1,2,3,3"]
.Diff√©rentes mani√®res d'exprimer des versions
|===
Symbole, Version, Repr√©sentation alternative, Repr√©sentation √©tendue
   , `1.0.0`, -, -
`^`, `^1.0.0`, `1.x.x`, `>=1.0.0 <2.0.0`
`~`, `~1.0.0`, `1.0.x`, `>=1.0.0 <1.1.0`
`*`, `*`, `x.x.x`, `>=0.0.1`
|===

Je ne pense pas qu'il soit n√©cessaire de se sentir oblig√©¬∑e de toujours
√™tre positionn√©¬∑e sur la derni√®re version majeure.
Les versions patch et mineures paraissent plus importantes √† mes yeux
car elles contiennent des corrections qui peuvent b√©n√©ficier √† nos applications.

[TIP]
.[RemarquePreTitre]#Outil# Calculateur de version
====
L'outil en ligne [URL]#https://semver.npmjs.com# sert √† tester
la syntaxe des versions s√©mantiques avec de v√©ritables modules npm.
====

[[update]]
=== Mises √† jour

Nous avons appris √† installer des modules npm dans les versions de notre choix
et √† les r√©installer depuis la liste contenue dans le fichier `package.json`.
Comment savoir si ces derniers sont √† mettre √† jour ?

L'utilisation combin√©e des commandes `npm outdated` et `npm update` va
nous permettre d'y arriver.
Il sera plus facile de comprendre cette partie si vous vous √™tes familiaris√©¬∑e
avec la notion de <<semver,version s√©mantique>>.

Commen√ßons par installer d'anciennes versions des modules _lodash_ et _cowsay_ :

----
$ npm install lodash@2.0.0 cowsay@1.0.0
----

La commande `npm outdated` affiche les d√©pendances qui ne sont pas √† jour :

[subs="+attributes"]
----
$ npm outdated
Package  Current  Wanted   Latest  Location
cowsay     1.0.0   1.3.0    1.3.0  nodebook.chapter-05
lodash     2.0.0   2.4.2  {lodashVersion}  nodebook.chapter-05
----

Le num√©ro de version affich√© dans la colonne `Wanted` est celui qui sera atteint
avec la commande `npm update`.

----
$ npm update
+ cowsay@1.3.0
+ lodash@2.4.2
added 7 packages and updated 3 packages in 2.717s
----

Observons ce qui a chang√© dans les r√©sultats de la commande `npm oudated` :

[subs="+attributes"]
----
$ npm outdated
Package  Current  Wanted   Latest  Location
lodash     2.4.2   2.4.2  {lodashVersion}  nodebook.chapter-05
----

Seul le module _lodash_ est d√©sormais list√©.
Les modules _cowsay_ et _lodash_ ont √©t√© mis √† jour au plus s√ªr.
Le module _lodash_ peut rester en l'√©tat si nous n'avons pas le temps
de rendre notre code compatible avec ses changements.

Sinon, une <<install.version,installation manuelle>> s'impose
avec l'√©tiquette `latest` :

[subs="+attributes"]
----
$ npm install lodash@latest
+ lodash@{lodashVersion}
----

Un dernier appel √† `npm outdated` nous permet d'en avoir le c≈ìur net :

----
$ npm outdated
----

Si rien ne s'affiche, c'est que tout est bon : nos modules sont √† jour !

== Autres mani√®res d'installer et d'utiliser des modules npm

Dans la section pr√©c√©dente, nous avons appris √† installer des modules
depuis le registre npm. +
Dans cette section, nous allons apprendre √† les installer depuis des sources
vari√©es, uniquement √† des fins de d√©veloppement ou en tant que
commandes ex√©cutables au niveau du syst√®me d'exploitation.

=== Depuis GitHub, GitLab ou un d√©p√¥t Git

Il arrive que nous ayons √† utiliser une version modifi√©e d'un module npm
avant que l'auteur ou autrice accepte une correction de bug qui nous affecte.
√áa vaut aussi pour des modules dont le code serait h√©berg√© dans un d√©p√¥t priv√©
et que nous ne voulons pas publier sur le registre npm.

Le module npm _cowsay_ est h√©berg√© sur GitHub √† l'adresse
[URL]#https://github.com/piuccio/cowsay#.

----
$ npm install github:piuccio/cowsay
+ cowsay@1.3.0
updated 1 package in 5.866s
----

Il s'agit en r√©alit√© d'une √©criture raccourcie.
Nous sommes aussi en mesure d'utiliser l'URL d'un d√©p√¥t Git
‚Äî pas forc√©ment GitHub ou GitLab donc :

----
$ npm install https://github.com/piuccio/cowsay
+ cowsay@1.3.0
updated 1 package in 4.513s
----

[CAUTION]
.[RemarquePreTitre]#Consid√©rations# Performance d'acc√®s √† Git
====
L'installation est plus lente depuis un d√©p√¥t Git que depuis un registre npm.
L'ex√©cutable `npm` fait appel √† l'ex√©cutable `git` pour cloner l'historique
du d√©p√¥t et de ses d√©pendances pour extraire la version ad√©quate
de la copie de travail.

Le temps de t√©l√©chargement sera proportionnel au nombre de _commits_.
====

L'ex√©cutable `npm` sait aussi installer des modules avec les protocoles
`git+ssh` et `git`.

----
$ npm install git://github.com:piuccio/cowsay.git
+ cowsay@1.3.0
updated 1 package in 10.263s
----

Le client Git ou SSH doivent √™tre configur√©s au niveau du syst√®me pour
√™tre en mesure de s'authentifier sur l'h√¥te distant. +
C'est une solution √† privil√©gier pour les d√©p√¥ts priv√©s ‚Äî la configuration
des d√©p√¥ts priv√©s via le protocole `https` est trop difficile √† automatiser.

[[install.dev]]
=== En tant que d√©pendance de d√©veloppement

Les d√©pendances de d√©veloppement sont des modules npm utilis√©s
pour *ex√©cuter les tests unitaires*.
Les *modules utilis√©s pour de l'outillage* et qui ne sont pas appel√©s
avec la fonction `require()` sont aussi des d√©pendances de d√©veloppement.

Par exemple, le module npm _mocha_ est utilis√© pour structurer et ex√©cuter
des tests unitaires √©crits en ECMAScript ‚Äî pour Node et les navigateurs web.
Il serait donc logique de l'installer comme d√©pendance de d√©veloppement.
L'option `--save-dev` permet de signaler cette intention √† l'ex√©cutable `npm` :

[subs="+attributes"]
----
$ npm install --save-dev mocha
+ mocha@{mochaVersion}
----

L'ex√©cutable `npm` range alors ce module dans une nouvelle section du
fichier `package.json` ‚Äî la section `devDependencies` :

[source,json,subs="+attributes,-specialchars"]
----
{
  ...
  "dependencies": {
    "cowsay": "^1.3.0",
    "lodash": "^{lodashVersion}"
  },
  "<i>devDependencies</i>": {
    "mocha": "^5.2.0"
  }
}
----

Les d√©pendances de d√©veloppement sont install√©es uniquement lorsque
la commande `npm install` est invoqu√©e dans le m√™me r√©pertoire
que le fichier `package.json`

√Ä l'inverse, si vous faisons `npm install cowsay`, ses d√©pendances de
d√©veloppement ne seront pas install√©es pour gagner du temps.

[TIP]
.[RemarquePreTitre]#Pratique# Lister les d√©pendances de d√©veloppement d'un module
====
La <<view,commande `npm view`>> combin√©e √† l'option `devDependencies`
retourne toutes les d√©pendances de d√©veloppement d'un module donn√© :

----
$ npm view cowsay devDependencies
{ nodeunit: '~0.11.1',
  rollup: '^0.48.2',
  'rollup-plugin-commonjs': '^8.2.0',
  'rollup-plugin-node-resolve': '^3.0.0',
  'rollup-plugin-string': '^2.0.2' }
----

Ce sont autant de d√©pendances qui ne sont pas install√©es dans notre projet.
====

[TIP]
.[RemarquePreTitre]#Optimisation# Installer seulement les d√©pendances de production
====
La <<install,commande `npm install`>> accepte l'option `--production`.
Seules les d√©pendances list√©es dans la section `dependencies`
du fichier `package.json` seront alors install√©es :

----
$ npm install --production
----
====

[[install.global]]
=== En tant qu'ex√©cutable syst√®me (installation globale)

Nous avons parl√© des modules npm comme des modules compl√©mentaires,
utilis√©s avec la fonction `require()` et t√©l√©charg√©s avec l'ex√©cutable `npm`.
Certains modules npm se d√©clarent comme ex√©cutables depuis un terminal.

C'est le cas du module _serve_ ([URL]#https://npmjs.com/serve#), par exemple.
Il d√©marre un serveur web en ligne de commande pour tester le rendu
de fichiers HTML sans avoir √† configurer de logiciels comme _Apache_ ou _nginx_.

L'installation est rendue globale ‚Äî √† l'√©chelle du syst√®me d'exploitation
‚Äî avec l'utilisation de l'option `--global` :

[subs="+attributes"]
----
$ npm install <i>--global</i> serve
+ serve@{serveVersion}
----

[NOTE]
.[RemarquePreTitre]#Question# Comment savoir si un module npm s'installe comme un ex√©cutable syst√®me ?
====
En g√©n√©ral, les modules npm qui se pr√™tent bien au jeu du `npm install --global`
sont ceux qui documentent des exemples de commande √† ex√©cuter,
qui se d√©crivent comme des outils en ligne de commande ou qui
mentionnent explicitement l'installation globale.
====

L'ex√©cutable `serve` est disponible suite √† l'installation globale :

[subs="+attributes"]
----
$ serve --version
{serveVersion}
----

Le module npm s'ex√©cute de mani√®re transparente, sans invoquer Node ni
l'ex√©cutable `npm` :

----
$ serve .
INFO: Accepting connections at http://localhost:3000
----

[TIP]
.[RemarquePreTitre]#Documentation# L'option `--help`
====
Par convention, les modules npm qui s'utilisent en ligne de commande
embarquent une documentation.
Ce manuel d√©crit des cas d'usages ainsi que les options √† disposition.

.Affichage de la documentation du module npm _serve_ depuis la ligne de commande.
----
$ serve --help
----
====

Un module npm install√© de mani√®re globale se d√©sinstalle en passant l'option
`--global` √† la <<uninstall,commande `npm uninstall`>> :

----
$ npm uninstall -g serve
----

Le <<../chapter-08/index.adoc#,chapitre 8>> sera l'occasion d'entrer plus en d√©tails
dans le d√©veloppement d'ex√©cutables syst√®me √©crits en ECMAScript.


== Outiller un projet avec les scripts npm

Les scripts npm sont des outils puissants qui *autonomisent l'outillage projet*,
*automatisent des actions* manuelles et *simplifient des actions* trop
complexes √† m√©moriser.

Les scripts npm sont consign√©s dans la section `scripts` du fichier `package.json`.
Ils se basent sur des scripts Node et des modules npm pour
lancer des actions quand des fichiers sont modifi√©s,
transformer des feuilles de style, ex√©cuter des tests unitaires ou fonctionnels,
d√©ployer le projet, entre autres.

Les scripts npm permettent de cr√©er des conventions entre nos projets.
Nous pouvons ainsi r√©utiliser les m√™mes noms et adapter les commandes
au projet en question.

[[start]]
=== D√©marrer l'application

Le script `npm start` concerne les projets dont le script principal
tourne en continu ‚Äî une application web par exemple.

L'exemple suivant d√©marre un serveur web sans que nous ayons √† conna√Ætre
la commande associ√©e pour d√©marrer le-dit serveur :

----
$ npm start

> nodebook.chapter-05@1.0.0 start         # <1>
> micro examples/app.js                   # <2>

micro: Accepting connections on port 3000
----
<1> L'ex√©cutable `npm` affiche le nom du script npm en cours d'ex√©cution
<2> `micro examples/app.js` est la commande r√©ellement ex√©cut√©e par npm

Nous sommes libre de renseigner la valeur du champ `scripts.start`
du fichier `package.json` comme bon nous semble :

[source,json,subs="+attributes"]
.package.json
----
{
  ...
  "scripts": {
    "start": "micro examples/app.js"
  },
  "dependencies": {
    "micro": "^{microVersion}"
  }
}
----

Nous avons utilis√© le module npm _micro_ ([URL]#https://npmjs.com/micro#)
pour d√©marrer une application web.
Plus exactement, nous avons utilis√© l'ex√©cutable fourni par ce module.

[TIP]
.[RemarquePreTitre]#Pratique# Les modules npm ex√©cutables dans les scripts npm
====
Les <<install.global,modules npm ex√©cutables>> sont disponibles au niveau du
syst√®me lorsqu'ils sont install√©s avec l'option `--global`.

Les ex√©cutables des modules npm list√©s dans `dependencies` et `devDependencies`
sont utilisables dans les scripts npm.

Nous pouvons ainsi contenir tous les ex√©cutables n√©cessaires dans les
d√©pendances du projet.
====

Nous verrons dans le <<../chapter-06/index.adoc,chapitre 6>> que les
plates-formes de service utilisent aussi la valeur du champ `scripts.start`
pour d√©terminer comment d√©marrer notre application.

[[test]]
=== Ex√©cuter des tests

Le script `npm test` concerne tous les projets pour qui nous avons √©crit
des tests qu'ils soient unitaires ou fonctionnels.

L'intention de la commande lanc√©e par le script npm est de terminer
en erreur si un des tests n'aboutit pas au r√©sultat escompt√©.

L'exemple suivant lance un test unitaire qui s'assure de la coh√©rence
d'un des exemples pr√©c√©dents :

----
$ npm test

> nodebook.chapter-05@1.0.0 test  # <1>
> mocha examples/tests.js         # <2>

app.js
  ‚úì prints a cow as a response

1 passing
----
<1> L'ex√©cutable `npm` affiche le nom du script npm en cours d'ex√©cution
<2> `mocha examples/tests.js` est la commande r√©ellement ex√©cut√©e par npm

Cette fois-ci, nous avons personnalis√© la valeur du champ `scripts.test`
du fichier `package.json` :

[source,json,subs="+attributes"]
.package.json
----
{
  ...
  "scripts": {
    "test": "mocha examples/tests.js"
  },
  "devDependencies": {
    "mocha": "^{mochaVersion}"
  }
}
----

Nous avons eu recourt au module npm _mocha_ ([URL]#https://npmjs.com/mocha#).
De m√™me qu'avec le <<start,script de d√©marrage>>, nous avons eu recourt
√† l'ex√©cutable fourni par le module.
En revanche nous l'avons list√© dans la <<install.dev,section `devDependencies`>>
car il est relatif √† l'outillage du projet.

Les services d'int√©gration continue lancent le script `npm test`
lorsqu'ils d√©tectent qu'ils ont affaire √† un projet Node.

[NOTE]
.[RemarquePreTitre]#Documentation# Scripts d√©finis par npm
====
D'autres scripts que `test` et `start` sont d√©finis par l'ex√©cutable `npm`.
Ils sont tous document√©s sur [URL]#https://docs.npmjs.com/misc/scripts#.
====

[[run]]
=== Cr√©er un script npm personnalis√©

Les scripts npm personnalis√©s sont utiles *lorsque nous souhaitons outiller*
notre projet sans forc√©ment que √ßa soit en rapport avec le lancement des tests
ou de l'application.

Les scripts personnalis√©s se d√©marrent avec `npm run` :

----
$ npm <i>run</i> print-args

> nodebook.chapter-05@1.0.0 print-args
> node examples/print-args.js

Rien √† signaler.
----

Nous avons cr√©√© ce script en configurant la valeur du champ `scripts.print-args`
du fichier `package.json` :

[source,json]
.package.json
----
{
  ...
  "scripts": {
    "print-args": "node examples/print-args.js"
  }
}
----

[TIP]
.[RemarquePreTitre]#Pratique# Lister les scripts disponibles
====
La commande `npm run` (sans argument) liste tous les scripts npm du projet.
====

J'ai d√©velopp√© ces conventions avec le temps :

- `npm run build` : construit les art√©facts √† d√©ployer ;
- `npm run deploy` : d√©ploie le projet vers l'h√©bergeur ;
- `npm run lint` : applique un v√©rificateur syntaxique au code du projet ;
- `npm run watch` : d√©marre l'application et la relance √† chaque changement.

[TIP]
.[RemarquePreTitre]#Pratique# Passer des arguments √† un script npm
====
Une option sp√©ciale nous aide √† transmettre des arguments au script en question.
Les arguments doivent √™tre plac√©s √† droite de l'option `--` :

----
$ npm run print-args un --test=true
['un']
$ npm run print-args -- un --test=true
['un', '--test=true']
----
====

Un script npm peut faire appel √† d'autres scripts npm :

[source,json,subs="-specialchars"]
.package.json
----
{
  ...
  "scripts": {
    "lint": "eslint ./examples",
    "test": "npm run lint <i>&&</i> mocha examples/tests.js"
  }
}
----

J'ai plut√¥t tendance √† d√©couper mes scripts de sorte √† ce qu'ils fassent
tous une chose et une seule.
Je peux ainsi les appeler de mani√®re individuelle pour r√©duire la boucle
de feedback.

[source,json,subs="-specialchars"]
.package.json
----
{
  ...
  "scripts": {
    "lint": "eslint ./examples",
    "test": "npm run lint && npm run test:unit",
    "test:unit": "mocha examples/tests.js"
  }
}
----

La section suivante va nous aider √† orchestrer l'ex√©cution des scripts
les uns par rapport aux autres.

[[run-pre-post]]
=== Ex√©cuter des commandes avant et apr√®s des scripts npm

L'ordre d'ex√©cution des scripts se contr√¥le en utilisant les pr√©fixes
`pre` et `post`.
Par exemple, les scripts nomm√©s `pretest` et `posttest` seront ex√©cut√©s
respectivement avant et apr√®s le script `test`.

[source,json,subs="-specialchars"]
.package.json
----
{
  ...
  "scripts": {
    "lint": "eslint ./examples",
    "test": "mocha examples/tests.js",
    "<i>pre</i>test": "npm run lint"
  }
}
----

Dans cet exemple de configuration, l'ex√©cution de la commande `npm test`
lancera d'abord le script `pretest`, puis le script `lint`
puis enfin le script `test` :

----
$ npm test

> nodebook.chapter-05@1.0.0 pretest
> npm run lint
...

> nodebook.chapter-05@1.0.0 lint
> eslint ./examples
...

> nodebook.chapter-05@1.0.0 test
> mocha examples/tests.js
...
----

Ce m√©canisme est utile pour s'intercaler sur des temps particuliers
du cycle de vie d'un projet node.
Voici une s√©lection

[format="csv", options="header", separator=";", cols="1,2,2"]
|===
Script; Quand; Pourquoi
`pretest`; Avant les tests; Pr√©parer l'espace de travail
`posttest`; Apr√®s les tests; V√©rifier les r√®gles de syntaxe de notre code
`postinstall`; Apr√®s installation les d√©pendances; Pr√©paration significative du projet (t√©l√©chargements suppl√©mentaires, etc.)
`prestart`; Avant de d√©marrer l'application; Pr√©paratifs l√©gers
`prepublishOnly`; Avant de publier le module; Pr√©paration du projet avant de le distribuer (compilation de fichiers, etc.)
|===

== Quelques commandes pour aller plus loin

[[view]]
=== `npm view` : voir les informations d'un module

[[home]]
=== `npm home` : visiter le site web d'un module

[[audit]]
=== `npm audit` : v√©rifier la s√©curit√© des d√©pendances

[[prune]]
=== `npm prune` : supprimer les d√©pendances inutilis√©es

[[doctor]]
=== `npm doctor` : v√©rifier l'√©tat du syst√®me

[[config]]
=== `npm config` : changer les r√©glages de l'ex√©cutable `npm`

[[link]]
=== `npm link` : utiliser une d√©pendance qui n'a pas encore √©t√© publi√©e

[[publish]]
=== `npm publish` : publier un module npm

----
npm notice
npm notice üì¶  asciidoctor-extension-interactive-runner@1.2.0
npm notice === Tarball Contents ===
npm notice 740B  package.json
npm notice 1.3MB demo.gif
npm notice 1.8kB index.js
npm notice 1.1kB LICENSE
npm notice 1.0kB README.md
npm notice 2.1kB src/docinfo.js
npm notice 730B  src/style.css
npm notice === Tarball Details ===
npm notice name:          asciidoctor-extension-interactive-runner
npm notice version:       1.2.0
npm notice package size:  1.2 MB
npm notice unpacked size: 1.3 MB
npm notice shasum:        c55c6f98f7817a0dc45e6bb4700d5aaa4accc002
npm notice integrity:     sha512-hVR01IMtWHhrd[...]S4OQ5IQvzm00w==
npm notice total files:   7
npm notice
+ asciidoctor-extension-interactive-runner@1.2.0
----

Parler de .npmignore et de .gitignore

== Questions et myst√®res autour de npm

=== Je ne vois pas l'int√©r√™t du fichier `package-lock.json`

=== npm c'est pour le backend, bower (ou autre) pour le frontend

=== Est-ce que je dois versionner le r√©pertoire `node_modules` ?

=== Il para√Æt que Yarn, c'est mieux

=== npm est lent, il installe la moiti√© d'Internet √† chaque fois

=== Que signifient les erreurs affich√©es pendant `npm install` ?


== Conclusion
