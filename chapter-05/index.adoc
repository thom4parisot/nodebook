:chapterNumber: 5
:chapterId: chapter-05
:sourceDir: ./examples
:httpRoot: http://localhost:3000
:nodeCurrentVersion: v10
:npmCurrentVersion: v6
:lodashVersion: 4.17.10
:mochaVersion: 5.2.0
:serveVersion: 7.2.0
:microVersion: 9.3.2
:npmvX: 6.1.0
:sectnums:
:revdate: {docdate}
:imagesdir: {indir}
ifdef::env[]
:imagesdir: .
endif::[]

= Jouer avec npm

TBD.

====
.Sommaire
- CrÃ©er un fichier `package.json`
- Installer un module npm
- Outiller un projet avec les scripts npm
- Quelques commandes pour aller plus loin
- Questions et mystÃ¨res autour de npm
====

[abstract]
--
TBD.
--

include::../resources/tip-versions.adoc[]

Le mot _npm_ correspond Ã  trois concepts diffÃ©rents que nous aborderons
tout au long de ce chapitre :

- l'*exÃ©cutable* `npm` â€” un programme Ã©crit en JavaScript ;
- le *registre* _npm_ â€” une plate-forme de distribution de modules ;
- un *module* _npm_ â€” en gÃ©nÃ©ral installÃ© depuis le registre et utilisable avec la fonction `require()`.

Je prÃ©ciserai toujours si l'utilisation de _npm_ fait rÃ©fÃ©rence
Ã  l'_exÃ©cutable_, au _registre_ ou Ã  un _module_.

L'exÃ©cutable `npm` est installÃ© par dÃ©faut avec Node.
VÃ©rifions la version installÃ©e en ouvrant un terminal
et en Ã©crivant la commande suivante :

[subs="+attributes"]
----
$ npm --version
{npmvX}
----

Si un message s'affiche en indiquant que `npm` n'est pas un programme reconnu,
veuillez vous rÃ©fÃ©rer au <<../chapter-02/index.adoc,chapitre 2>> et
vÃ©rifier que Node {nodeCurrentVersion} est bien installÃ©.

include::../resources/tip-examples.adoc[]


[[cli]]
== CrÃ©er un fichier `package.json`

La prÃ©sence d'un fichier `package.json` est nÃ©cessaire pour utiliser npm
dans un projet.
La commande `npm init` gÃ©nÃ¨re un tel fichier en nous posant des questions.
Nous irons plus vite en utilisant l'option `--yes` :

----
$ npm init --yes
----

Le fichier `package.json` sera crÃ©Ã© avec le contenu suivant :

----
{
  "name": "<nom du rÃ©pertoire>",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}
----

Si le fichier existait dÃ©jÃ , la copie existante sera prÃ©servÃ©e et affichÃ©e
Ã  l'Ã©cran.

Nous allons ignorer le contenu du fichier dans un premier temps
afin de nous focaliser sur l'opÃ©ration la plus importante et la plus
frÃ©quemment utilisÃ©e :
l'installation de modules npm avec la commande `npm install`.

[[modules]]
== Installer des modules npm

Le mÃ©canisme de modules est documentÃ© dans
le <<../chapter-04/index.adoc#,chapitre 4>>.
La fonction `require()` charge nos propres modules mais aussi
les modules de base, proposÃ©s par Node.
Les modules npm sont des *modules complÃ©mentaires et tÃ©lÃ©chargeables* Ã  l'aide
de l'exÃ©cutable `npm`.

Cette section va nous aider Ã  comprendre ce qu'il se passe sous le capot
pendant les phases d'installation, de mise Ã  jour et de dÃ©sinstallation
des modules npm.

=== Depuis le registre npm

Le registre npm ([URL]#https://npmjs.com#) est l'hÃ©bergement principal
des modules JavaScript.

La commande `npm install` s'utilise directement quand nous connaissons dÃ©jÃ 
le nom d'un module Ã  installer,
par exemple le module _cowsay_ ([URL]#https://npmjs.com/cowsay#) :

----
$ npm install cowsay
+ cowsay@1.3.0
added 10 packages from 3 contributors in 1.667s
found 0 vulnerabilities
----

Le module est installÃ© et prÃªt Ã  Ãªtre inclus dans un script.
Nous pouvons aussi constater que le champ `dependencies` est apparu
dans le fichier `package.json` :

[source,json]
.package.json
----
{
  ...
  "dependencies": {
    "cowsay": "^1.3.0"
  }
}
----

L'exÃ©cutable `npm` tient les comptes des modules installÃ©s Ã  notre demande.
Ã‡a nous sera utile pour <<install,installer les modules sur un autre ordinateur>>.
Nous reviendrons plus tard sur la notation des versions
â€” on en reparlera sous le nom de _versions sÃ©mantiques_ (_Semantic Versionning_).

[source%interactive,javascript]
.cow.js
----
include::{sourceDir}/cow.js[]
----

Nous pouvons remarquer que l'inclusion d'un module npm est identique
Ã  celle d'un <<../chapter-04/index.adoc#modules-builtin,module de base>>. +
Regardons le rÃ©sultat sans plus tarder :

----
$ node cow.js
___________
< Bonjour ! >
-----------
       \   ^__^
        \  (oo)\_______
           (__)\       )\/\
               ||----w |
----

L'utilisation d'un module npm nous a permis d'utiliser du code sans avoir Ã  le
crÃ©er alors qu'il n'Ã©tait pas fourni par la plate-forme Node.

Maintenant que nous savons installer un module npm, nous pouvons en chercher
d'autres et comprendre comment les utiliser.

[NOTE]
.[RemarquePreTitre]#Question# OÃ¹ sont stockÃ©s les modules npm ?
====
Les modules npm et leurs dÃ©pendances sont stockÃ©s dans un rÃ©pertoire
`node_modules`.
Ce rÃ©pertoire est situÃ© au mÃªme niveau que le fichier `package.json`.
====


[NOTE]
.[RemarquePreTitre]#Sous le capÃ´t# Ce que fait l'exÃ©cutable `npm` pendant l'installation
====
L'exÃ©cutable `npm` effectue un bon nombre d'actions aprÃ¨s avoir
saisi la commande `npm install cowsay` :

1. il interroge le registre _npmjs.com_ pour obtenir des informations sur le module demandÃ© ;
2. il dÃ©termine que `1.3.0` est la version la plus rÃ©cente ;
3. il tÃ©lÃ©charge une archive compressÃ©e (`.tar.gz`) qui contient tous les fichiers de la version `1.3.0` ;
4. l'archive est dÃ©compressÃ©e dans le rÃ©pertoire `node_modules` ;
5. les dÃ©pendances sont elles aussi tÃ©lÃ©chargÃ©es puis dÃ©compressÃ©es dans le rÃ©pertoire `node_modules` ;
6. le module `cowsay` est inscrit dans le fichier `package.json`.
====

[NOTE]
.[RemarquePreTitre]#Remarque# DÃ©pendances de dÃ©veloppement
====
Il existe une variante de la commande pour distinguer les dÃ©pendances
spÃ©cifiques Ã  l'outillage du projet.
Rendez-vous dans la section <<install.dev,dÃ©pendances de dÃ©veloppement>>
pour en savoir plus.
====


[[registry]]
=== Trouver son bonheur dans le registre npm

Le _registre npm_ ([URL]#https://npmjs.com#) fourmille de modules
â€” de simples fonctions, des librairies ou des _frameworks_ complets.
Ils couvrent un spectre d'usages allant de l'accÃ¨s aux bases de donnÃ©es,
Ã  des frameworks web, Ã  des outils frontend, des utilitaires de test,
de compression de donnÃ©es, du paiement bancaire, des frameworks mobiles, etc.

Essayons de chercher une librairie qui puisse nous connecter Ã  une
base de donnÃ©es MySQL ou MariaDB.
Tapez `mysql` dans le champ de recherche du registre npm ou saisissez
directement l'URL menant aux rÃ©sultats de cette recherche en vous
rendant sur [URL]#https://npmjs.com/search?q=mysql# :

.Extrait des rÃ©sultats d'une recherche de modules npm avec le mot-clÃ© _mysql_.
image::images/npm-registry-search.png[]

Les rÃ©sultats sont triÃ©s par pertinence â€” un mÃ©lange entre popularitÃ©,
qualitÃ© et maintenance des projets.

Je trouve qu'il est difficile de dÃ©cider uniquement en regardant la liste.
J'ai tendance Ã  ouvrir un onglet par module pour lire leur documentation.
Prenons le cas du module _mysql2_ ([URL]#https://npmjs.com/mysql2#) justement :

.Extrait de la page consacrÃ©e au module npm _mysql2_.
image::images/npm-package-mysql2.png[]

Plusieurs Ã©lÃ©ments de cette page tendent Ã  me rassurer
et m'aident Ã  juger de la robustesse de ce module :

- les badges colorÃ©s qui affichent le statut d'exÃ©cution des tests ;
- une introduction de *documentation claire et concise* ;
- un *nombre de tÃ©lÃ©chargements* en progrÃ¨s rÃ©guliers ;
- il s'utilise avec des <<../chapter-03/index.adoc#promise,promesses>> ;
- le nombre important de modules dÃ©pendants ;
- *je reconnais une autrice* qui contribue du code de qualitÃ©
â€” Rebecca Turner ([URL]#https://npmjs.com/~iarna#).

J'ai un doute quand je lis _108 issues_ et _13 pull requests_.
Dans ce cas-lÃ  je me dis que les personnes qui maintiennent le projet ne sont
pas forcÃ©ment trÃ¨s rÃ©actives.

Cependant, il y a suffisamment d'indicateurs au vert pour l'installer Ã  coup de
`npm install mysql2` puis Ã  l'essayer dans un script.

Le module _mysql-libmysqlclient_ ([URL]#https://npmjs.com/mysql-libmysqlclient#)
ne me fait pas du tout le mÃªme effet :

.Extrait de la page consacrÃ©e au module npm _mysql-libmysqlclient_.
image::images/npm-package-mysql-libmysqlclient.png[]

La page du module ne met pas d'exemple simple Ã  comprendre et fait rÃ©fÃ©rence
Ã  des versions de Node antÃ©diluviennes.
Rien n'indique qu'il ne peut pas fonctionner avec Node {nodeCurrentVersion}
mais la prÃ©sence du mot _binding_ m'Ã©voque que l'installation du module
compile un programme Ã©crit dans un autre langage
â€” en l'occurrence, _libmysqlclient_.

Point positif : il n'y a que 14 _issues_ GitHub.
C'est peu mais l'une d'entre elle est intitulÃ©e
Â« __Does not work with any modern version of Node.js__ Â».
Ã‡a confirme les doutes du paragraphe prÃ©cÃ©dent :
c'est suffisant pour que je passe mon chemin.

En continuant plus loin dans la liste des rÃ©sultats de recherche,
je suis tombÃ© sur le module npm nommÃ© _falchion_ :

.Extrait de la page consacrÃ©e au module npm _falchion_.
image::images/npm-package-falchion.png[]

Il n'y a qu'une seule version du module, qui date de quatre annÃ©es
avec une documentation qui tient sur une ligne. +
Il y a trÃ¨s peu de chances que nous puissions en faire quelque chose.

---

Voici au final ce que j'estime Ãªtre le plus important pour me faire
une idÃ©e d'un module et dÃ©cider de l'installer ou non :

- prÃ©sence d'une *documentation* â€” je peux me faire une idÃ©e des fonctionnalitÃ©s
et de la complexitÃ© d'utilisation du module ;
- des badges d'*intÃ©gration continue* â€” je sais ainsi qu'il y a des tests
unitaires qui sont exÃ©cutÃ©s automatiquement avant que le module soit publiÃ© ;
- le nombre de *tÃ©lÃ©chargements* â€” je sais si d'autres personnes s'en servent
en espÃ©rant qu'ils remontent les problÃ¨mes rencontrÃ©s ;
- le nombre de *versions* â€” Ã§a me donne une idÃ©e de la maturitÃ© du projet
et de la rÃ©activitÃ© aux demandes de la communautÃ©.

Ce sont des *critÃ¨res subjectifs*.
Un module peut Ãªtre populaire par anciennetÃ© alors qu'il existe des alternatives,
plus lÃ©gÃ¨res ou plus simple d'utilisation.
C'est le cas du module _moment.js_ qui est plus populaire que _date-fns_
â€” alors que je prÃ©fÃ¨re ce dernier.

Il y a aussi des modules dans lesquels j'ai une confiance quasi-aveugle.
Ils sont publiÃ©s par les personnes prÃ©sentes dans cette liste non-exhaustive :

[format="csv"]
.Auteurs et autrices de modules npm Ã  suivre
|===
dougwilson, [URL]#https://npmjs.com/~dougwilson#
feross, [URL]#https://npmjs.com/~feross#
fgribreau, [URL]#https://npmjs.com/~fgribreau#
iarna, [URL]#https://npmjs.com/~iarna#
isaacs, [URL]#https://npmjs.com/~isaacs#
jdalton, [URL]#https://github.com/jdalton#
jshttp, [URL]#https://github.com/jshttp#
mbostock, [URL]#https://npmjs.com/~mbostock#
nodejitsu, [URL]#https://github.com/nodejitsu#
rwaldron, [URL]#https://npmjs.com/~rwaldron#
sindresorhus, [URL]#https://npmjs.com/~sindresorhus#
substack, [URL]#https://npmjs.com/~substack#
zkat, [URL]#https://npmjs.com/~zkat#
|===

[TIP]
.[RemarquePreTitre]#Pratique# SÃ©lection de modules npm
====
J'ai compilÃ© une liste de modules utiles pour mieux dÃ©marrer
dans vos projets.
Vous la trouverez en <<../appendix-a/index.adoc#,annexe A>>.
====

[[uninstall]]
=== DÃ©sinstaller un module

L'utilisation de la commande `npm uninstall` supprime un module npm
et les fichiers qu'il a installÃ© en toute sÃ©curitÃ©.
La commande le retire ensuite de la liste des dÃ©pendances
du fichier `package.json`.

----
$ npm uninstall cowsay
removed 10 packages in 1.963s
found 0 vulnerabilities
----

Le module _cowsay_ n'est plus installÃ©.
Que se passe-t-il si nous exÃ©cutons Ã  nouveau un l'exemple `cow.js` ?

----
$ node cow.js
internal/modules/cjs/loader.js:596
    throw err;
    ^

Error: Cannot find module 'cowsay'
----

Le chargement du module _cowsay_ a Ã©chouÃ© car Node n'arrive pas Ã  le trouver
â€” et c'est normal.

Nous devons Ã  nouveau lancer la commande `npm install cowsay`
pour que le script fonctionne Ã  nouveau.


[[install]]
=== Depuis un fichier `package.json`

Jusqu'Ã  prÃ©sent, nous avons installÃ© des modules en les ajoutant un par un.
La procÃ©dure est lÃ©gÃ¨rement diffÃ©rente quand nous installons le projet de zÃ©ro
ou si le fichier `package.json` a Ã©tÃ© mis Ã  jour par unÂ·e collÃ¨gue, par exemple.

Pour en avoir le cÅ“ur net, plaÃ§ons-nous dans le rÃ©pertoire qui contient
le fichier `package.json` et supprimons le rÃ©pertoire `node_modules`
qui contient les dÃ©pendances dÃ©jÃ  installÃ©es.
ExÃ©cutons ensuite la commande `npm install` sans autre argument :

----
$ cd $(nodebook dir chapter-05 --root)
$ rm -rf node_modules
$ npm install
added 164 packages from 583 contributors in 4.781s
found 0 vulnerabilities
----

Au final, la commande `npm install` s'utilise de maniÃ¨re systÃ©matique quand
nous rÃ©cupÃ©rons du code avec Git pour la premiÃ¨re fois (`git clone`)
ou aprÃ¨s une mise Ã  jour, par exemple avec `git pull`.

L'exÃ©cutable `npm` vÃ©rifie toujours que les modules npm installÃ©s dans
le rÃ©pertoire `node_modules` correspondent bien Ã  ceux qui sont listÃ©s
dans le fichier `package.json`.
Il installe, met Ã  jour et retire les modules npm en fonction de ce
qui est nÃ©cessaire.

[[install.version]]
=== SpÃ©cifier une version

Par dÃ©faut, l'exÃ©cutable `npm` installe la derniÃ¨re version d'un module.
Nous avons la libertÃ© d'en installer d'autres qui sont antÃ©rieures.
C'est pratique quand des modules npm arrÃªtent de supporter
des navigateurs web ou des versions de Node alors que nous les utilisons encore.

Nous allons utiliser le module _lodash_ ([URL]#https://npmjs.com/lodash#)
pour illustrer nos allÃ©es et venues entre diffÃ©rentes versions.
Ã€ l'heure oÃ¹ j'Ã©cris ces lignes, la version la plus rÃ©cente _lodash_
est la `{lodashVersion}`.
C'est ce que rapporte le rÃ©sultat de la commande `npm install lodash` :

[subs="+attributes"]
----
$ npm install lodash
+ lodash@{lodashVersion}
----

L'utilisation du caractÃ¨re `@` conjointe Ã  un numÃ©ro de version prÃ©cise
la version Ã  installer :

----
$ npm install lodash@3.0.0
+ lodash@3.0.0
----

Nous avons installÃ© une version prÃ©cise mais il y a surement des mises Ã  jour
qui ont suivi pour corriger des bugs.
Le problÃ¨me est qu'Ã  ce stade, nous ne connaissons pas le numÃ©ro de version
Ã  spÃ©cifier.
IdÃ©alement, je prÃ©fÃ¨rerais installer la version la plus rÃ©cente de la sÃ©rie 3.
Il se trouve que l'exÃ©cutable `npm` sait le faire pour nous et sans effort :

----
$ npm install lodash@3
+ lodash@<i>3.10.1</i>
----

Nous pouvons faire la mÃªme chose avec la version
la plus rÃ©cente de la sÃ©rie 3 et de la sÃ©rie 2.2 :

----
$ npm install lodash@3
+ lodash@3.10.1
$ npm install lodash@2.2
+ lodash@2.2.1
----

[TIP]
.[RemarquePreTitre]#Pratique# ConnaÃ®tre toutes les versions d'un module
====
La <<view,commande `npm view`>> affiche les informations d'un module npm
directement depuis notre terminal.
Elle affiche toutes les versions publiÃ©es avec l'argument `versions` :

----
$ npm view lodash <i>versions</i>
[ '0.1.0',
  '0.2.0',
  ...
  '1.0.0',
  '1.0.1',
  '1.0.2',
  ... ]
----
====

Revenons Ã  la version la plus rÃ©cente en rÃ©utilisant la
<<install,commande d'installation>> abordÃ©e auparavant :

----
$ npm install lodash
+ lodash@2.4.2
----

Quelque chose d'inattendu s'est produit : la version la plus rÃ©cente
de la sÃ©rie 2 a Ã©tÃ© installÃ©e au lieu de la version {lodashVersion}.
Nous trouverons un Ã©lÃ©ment de rÃ©ponse dans le fichier `package.json` :

[source,json,subs="-specialchars"]
.package.json
----
{
  ...
  "dependencies": {
    "cowsay": "^1.3.0",
    "lodash": "<i>^2.4.2</i>"
  }
}
----

L'exÃ©cutable `npm` respecte la version prÃ©cisÃ©e dans le fichier `package.json`
si elle n'est pas prÃ©cisÃ©e dans la commande.
Si la dÃ©pendance n'est pas listÃ©e, alors l'exÃ©cutable `npm` installe la version
la plus rÃ©cente.

L'Ã©tiquette `latest` explicite notre envie d'installer la version
la plus rÃ©cente et sans tenir compte du fichier `package.json` :

[subs="+attributes"]
----
$ npm install lodash@<i>latest</i>
+ lodash@{lodashVersion}
----

Nous sommes dÃ©sormais en mesure de choisir entre diffÃ©rentes versions
d'un module et de maniÃ¨re plus ou moins fine.

Nous prendrons le temps d'explorer le mÃ©canisme de numÃ©rotation des versions
dans la section suivante afin de mieux comprendre ce qui est renseignÃ©
dans le fichier `package.json`.

[TIP]
.[RemarquePreTitre]#Pratique# ConnaÃ®tre les Ã©tiquettes d'un module
====
La <<view,commande `npm view`>> va Ã  nouveau nous aider.
Elle affiche toutes les versions publiÃ©es avec l'argument `dist-tags` :

[subs="+attributes"]
----
$ npm view lodash dist-tags
{ <i>latest</i>: '{lodashVersion}' }
----

Ce mÃ©canisme d'Ã©tiquette sert de raccourci pour associer un numÃ©ro de version
(qui change) Ã  un intitulÃ© (qui reste dans le temps).
====


[[semver]]
=== Comprendre les numÃ©ros de versions (_Semantic Versioning_)

Les numÃ©ros de versions ont Ã©tÃ© utilisÃ©es de deux maniÃ¨res dans les
sections prÃ©cÃ©dentes : avec l'exÃ©cutable `npm` et en observant la liste
de dÃ©pendances dans le fichier `package.json`.

L'exÃ©cutable `npm` dÃ©coupe un numÃ©ro de version en trois parties :
_majeur_, _mineur_ et _patch_.
Pour le numÃ©ro de version `1.2.3`, `1` est le numÃ©ro de version majeur,
`2` est le numÃ©ro de version mineur tandis que  `3` est le numÃ©ro de version patch.

Si nous devions mettre Ã  jour `lodash@2.2.0` :

- vers `lodash@2.2.1` : mise Ã  jour patch â€” des bugs sont corrigÃ©s ;
- vers `lodash@2.4.2` : mise Ã  jour mineure â€” des fonctionnalitÃ©s sont ajoutÃ©es,
corrigÃ©es ou modifiÃ©es et ce, sans affecter notre code ;
- vers `lodash@{lodashVersion}` : mise Ã  jour majeure â€” des fonctionnalitÃ©s ont
Ã©tÃ© modifiÃ©es, remaniÃ©es ou supprimÃ©es et peuvent casser notre code qui repose dessus.

Une mise Ã  jour majeure demande de lire attentivement la documentation du module
pour comprendre le volume de travail Ã  fournir avant de monter en version.
La mise Ã  jour mineure peut occasionnellement demander du travail selon
interprÃ©tation des dÃ©veloppeurs de modules npm.

[format="csv", options="header", cols="1,2,3,3"]
.DiffÃ©rentes maniÃ¨res d'exprimer des versions
|===
Symbole, Version, ReprÃ©sentation alternative, ReprÃ©sentation Ã©tendue
   , `1.0.0`, -, -
`^`, `^1.0.0`, `1.x.x`, `>=1.0.0 <2.0.0`
`~`, `~1.0.0`, `1.0.x`, `>=1.0.0 <1.1.0`
`*`, `*`, `x.x.x`, `>=0.0.1`
|===

Je ne pense pas qu'il soit nÃ©cessaire de se sentir obligÃ©Â·e de toujours
Ãªtre positionnÃ©Â·e sur la derniÃ¨re version majeure.
Les versions patch et mineures sont plus importantes Ã  mes yeux
car elles contiennent des corrections qui peuvent bÃ©nÃ©ficier Ã  nos applications.

[TIP]
.[RemarquePreTitre]#Pratique# Calculateur de version
====
L'outil en ligne [URL]#https://semver.npmjs.com# sert Ã  tester
la syntaxe des versions sÃ©mantiques avec de vÃ©ritables modules npm.
====

[[update]]
=== Mises Ã  jour

Nous avons appris Ã  installer des modules npm dans les versions de notre choix
et Ã  les rÃ©installer depuis la liste contenue dans le fichier `package.json`.
Comment savoir si ces derniers sont Ã  mettre Ã  jour ?

L'utilisation combinÃ©e des commandes `npm outdated` et `npm update` va
nous permettre d'y arriver.
Il sera plus facile de comprendre cette partie si vous vous Ãªtes familiarisÃ©Â·e
avec la notion de <<semver,version sÃ©mantique>>.

CommenÃ§ons par installer d'anciennes versions des modules _lodash_ et _cowsay_ :

----
$ npm install lodash@2.0.0 cowsay@1.0.0
----

La commande `npm outdated` affiche les dÃ©pendances qui ne sont pas Ã  jour :

[subs="+attributes"]
----
$ npm outdated
Package  Current  Wanted   Latest  Location
cowsay     1.0.0   1.3.0    1.3.0  nodebook.chapter-05
lodash     2.0.0   2.4.2  {lodashVersion}  nodebook.chapter-05
----

Le numÃ©ro de version affichÃ© dans la colonne `Wanted` est celui qui sera atteint
avec la commande `npm update`.

----
$ npm update
+ cowsay@1.3.0
+ lodash@2.4.2
added 7 packages and updated 3 packages in 2.717s
----

Observons ce qui a changÃ© dans les rÃ©sultats de la commande `npm oudated` :

[subs="+attributes"]
----
$ npm outdated
Package  Current  Wanted   Latest  Location
lodash     2.4.2   2.4.2  {lodashVersion}  nodebook.chapter-05
----

Seul le module _lodash_ est dÃ©sormais listÃ©.
Les modules _cowsay_ et _lodash_ ont Ã©tÃ© mis Ã  jour au plus sÃ»r.
Le module _lodash_ peut rester en l'Ã©tat si nous n'avons pas le temps
de rendre notre code compatible avec ses changements.

Sinon, une <<install.version,installation manuelle>> s'impose
avec l'Ã©tiquette `latest` :

[subs="+attributes"]
----
$ npm install lodash@latest
+ lodash@{lodashVersion}
----

Un dernier appel Ã  `npm outdated` nous permet d'en avoir le cÅ“ur net :

----
$ npm outdated
----

Si rien ne s'affiche, c'est que tout est bon : nos modules sont Ã  jour !

== Autres maniÃ¨res d'installer et d'utiliser des modules npm

Dans la section prÃ©cÃ©dente, nous avons appris Ã  installer des modules
depuis le registre npm. +
Dans cette section, nous allons apprendre Ã  les installer depuis des sources
variÃ©es, uniquement Ã  des fins de dÃ©veloppement ou en tant que
commandes exÃ©cutables au niveau du systÃ¨me d'exploitation.

[[install.git]]
=== Depuis GitHub, GitLab ou un dÃ©pÃ´t Git

Il arrive que nous ayons Ã  utiliser une version modifiÃ©e d'un module npm
avant que l'auteur ou autrice accepte une correction de bug qui nous affecte.
Ã‡a vaut aussi pour des modules dont le code serait hÃ©bergÃ© dans un dÃ©pÃ´t privÃ©
et que nous ne voulons pas publier sur le registre npm.

Le module npm _cowsay_ est hÃ©bergÃ© sur GitHub Ã  l'adresse
[URL]#https://github.com/piuccio/cowsay#.

----
$ npm install github:piuccio/cowsay
+ cowsay@1.3.0
updated 1 package in 5.866s
----

Il s'agit en rÃ©alitÃ© d'une Ã©criture raccourcie.
Nous sommes aussi en mesure d'utiliser l'URL d'un dÃ©pÃ´t Git
â€” pas forcÃ©ment GitHub ou GitLab donc :

----
$ npm install https://github.com/piuccio/cowsay
+ cowsay@1.3.0
updated 1 package in 4.513s
----

[CAUTION]
.[RemarquePreTitre]#ConsidÃ©rations# Performance d'accÃ¨s Ã  Git
====
L'installation est plus lente depuis un dÃ©pÃ´t Git que depuis un registre npm.
L'exÃ©cutable `npm` fait appel Ã  l'exÃ©cutable `git` pour cloner l'historique
du dÃ©pÃ´t et de ses dÃ©pendances pour extraire la version adÃ©quate
de la copie de travail.

Le temps de tÃ©lÃ©chargement sera proportionnel au nombre de _commits_.
====

L'exÃ©cutable `npm` sait aussi installer des modules avec les protocoles
`git+ssh` et `git`.

----
$ npm install git://github.com:piuccio/cowsay.git
+ cowsay@1.3.0
updated 1 package in 10.263s
----

Les clients Git ou SSH doivent Ãªtre configurÃ©s au niveau du systÃ¨me pour
Ãªtre en mesure de s'authentifier sur l'hÃ´te distant. +
C'est une solution Ã  privilÃ©gier pour les dÃ©pÃ´ts privÃ©s â€” la configuration
des dÃ©pÃ´ts privÃ©s via le protocole `https` est trop difficile Ã  automatiser.

[[install.dev]]
=== DÃ©pendance de dÃ©veloppement

Les dÃ©pendances de dÃ©veloppement sont des modules npm utilisÃ©s
pour *exÃ©cuter les tests unitaires*.
Les *modules utilisÃ©s pour de l'outillage* et qui ne sont pas appelÃ©s
avec la fonction `require()` sont aussi des dÃ©pendances de dÃ©veloppement.

Par exemple, le module npm _mocha_ est utilisÃ© pour structurer et exÃ©cuter
des tests unitaires pour Node et les navigateurs web.
Il serait donc logique de l'installer comme dÃ©pendance de dÃ©veloppement.
L'option `--save-dev` permet de signaler cette intention Ã  l'exÃ©cutable `npm` :

[subs="+attributes"]
----
$ npm install --save-dev mocha
+ mocha@{mochaVersion}
----

L'exÃ©cutable `npm` range alors ce module dans une nouvelle section du
fichier `package.json` â€” la section `devDependencies` :

[source,json,subs="+attributes,-specialchars"]
----
{
  ...
  "dependencies": {
    "cowsay": "^1.3.0",
    "lodash": "^{lodashVersion}"
  },
  "<i>devDependencies</i>": {
    "mocha": "^5.2.0"
  }
}
----

Les dÃ©pendances de dÃ©veloppement sont installÃ©es uniquement lorsque
la commande `npm install` est invoquÃ©e dans le mÃªme rÃ©pertoire
que le fichier `package.json`

Ã€ l'inverse, si nous faisons `npm install cowsay`, ses dÃ©pendances de
dÃ©veloppement ne seront pas installÃ©es pour gagner du temps.


[TIP]
.[RemarquePreTitre]#Optimisation# Installer seulement les dÃ©pendances de production
====
La <<install,commande `npm install`>> accepte l'option `--production`.
Seules les dÃ©pendances listÃ©es dans la section `dependencies`
du fichier `package.json` seront alors installÃ©es :

----
$ npm install --production
----
====

[[install.global]]
=== ExÃ©cutable systÃ¨me (installation globale)

Nous avons parlÃ© des modules npm comme des modules complÃ©mentaires,
utilisÃ©s avec la fonction `require()` et tÃ©lÃ©chargÃ©s avec l'exÃ©cutable `npm`.
Certains modules npm se dÃ©clarent comme exÃ©cutables depuis un terminal.

C'est le cas du module _serve_ ([URL]#https://npmjs.com/serve#), par exemple.
Il dÃ©marre un serveur web en ligne de commande pour tester le rendu
de fichiers HTML sans avoir Ã  configurer de logiciels comme _Apache_ ou _nginx_.

L'installation est rendue globale â€” Ã  l'Ã©chelle du systÃ¨me d'exploitation
â€” avec l'utilisation de l'option `--global` :

[subs="+attributes"]
----
$ npm install <i>--global</i> serve
+ serve@{serveVersion}
----

[NOTE]
.[RemarquePreTitre]#Question# Comment savoir si un module npm s'installe comme un exÃ©cutable systÃ¨me ?
====
En gÃ©nÃ©ral, les modules npm qui se prÃªtent bien au jeu du `npm install --global`
sont ceux qui documentent des exemples de commande Ã  exÃ©cuter,
qui se dÃ©crivent comme des outils en ligne de commande ou qui
mentionnent explicitement l'installation globale.
====

L'exÃ©cutable `serve` est disponible suite Ã  l'installation globale :

[subs="+attributes"]
----
$ serve --version
{serveVersion}
----

Le module npm s'exÃ©cute de maniÃ¨re transparente, sans invoquer Node ni
l'exÃ©cutable `npm` :

----
$ serve .
INFO: Accepting connections at http://localhost:3000
----

[TIP]
.[RemarquePreTitre]#Documentation# L'option `--help`
====
Par convention, les modules npm qui s'utilisent en ligne de commande
sont accompagnÃ©s d'une documentation.
Ce manuel dÃ©crit des cas d'usages ainsi que les options Ã  disposition.

.Affichage de la documentation du module npm _serve_ depuis la ligne de commande.
----
$ serve --help
----
====

Un module npm installÃ© de maniÃ¨re globale se dÃ©sinstalle en passant l'option
`--global` Ã  la <<uninstall,commande `npm uninstall`>> :

----
$ npm uninstall -g serve
----

Le <<../chapter-08/index.adoc#,chapitre 8>> sera l'occasion d'entrer plus en dÃ©tails
dans le dÃ©veloppement d'exÃ©cutables systÃ¨me Ã©crits en ECMAScript.


[[scripts]]
== Outiller un projet avec les scripts npm

Les scripts npm sont des outils puissants qui *autonomisent l'outillage projet*,
*automatisent des actions* manuelles et *simplifient des actions* trop
complexes Ã  mÃ©moriser.

Les scripts npm sont consignÃ©s dans la section `scripts` du fichier `package.json`.
Ils se basent sur des scripts Node et des modules npm pour
lancer des actions quand des fichiers sont modifiÃ©s,
transformer des feuilles de style, exÃ©cuter des tests unitaires ou fonctionnels,
dÃ©ployer le projet, entre autres.

Les scripts npm permettent de crÃ©er des conventions entre nos projets.
Nous pouvons ainsi rÃ©utiliser les mÃªmes noms et adapter les commandes
au projet en question.

[[start]]
=== DÃ©marrer l'application

Le script `npm start` concerne les projets dont le script principal
tourne en continu â€” une application web par exemple.

L'exemple suivant dÃ©marre un serveur web sans que nous ayons Ã  connaÃ®tre
la commande associÃ©e pour dÃ©marrer le-dit serveur :

----
$ npm start

> nodebook.chapter-05@1.0.0 start         # <1>
> micro examples/app.js                   # <2>

micro: Accepting connections on port 3000
----
<1> L'exÃ©cutable `npm` affiche le nom du script npm en cours d'exÃ©cution
<2> `micro examples/app.js` est la commande rÃ©ellement exÃ©cutÃ©e par npm

Nous sommes libre de renseigner la valeur du champ `scripts.start`
du fichier `package.json` comme bon nous semble :

[source,json,subs="+attributes"]
.package.json
----
{
  ...
  "scripts": {
    "start": "micro examples/app.js"
  },
  "dependencies": {
    "micro": "^{microVersion}"
  }
}
----

Nous avons utilisÃ© le module npm _micro_ ([URL]#https://npmjs.com/micro#)
pour dÃ©marrer une application web.
Plus exactement, nous avons utilisÃ© l'exÃ©cutable fourni par ce module.

[TIP]
.[RemarquePreTitre]#Pratique# Les modules npm exÃ©cutables dans les scripts npm
====
Les <<install.global,modules npm exÃ©cutables>> sont disponibles au niveau du
systÃ¨me lorsqu'ils sont installÃ©s avec l'option `--global`.

Les exÃ©cutables des modules npm listÃ©s dans `dependencies` et `devDependencies`
sont utilisables dans les scripts npm.

Nous pouvons ainsi contenir tous les exÃ©cutables nÃ©cessaires dans les
dÃ©pendances du projet.
====

Nous verrons dans le <<../chapter-06/index.adoc,chapitre 6>> que les
plates-formes de service utilisent aussi la valeur du champ `scripts.start`
pour dÃ©terminer comment dÃ©marrer notre application.

[[test]]
=== ExÃ©cuter des tests

Le script `npm test` concerne tous les projets pour qui nous avons Ã©crit
des tests qu'ils soient unitaires ou fonctionnels.

L'intention de la commande lancÃ©e par le script npm est de terminer
en erreur si un des tests n'aboutit pas au rÃ©sultat escomptÃ©.

L'exemple suivant lance un test unitaire qui s'assure de la cohÃ©rence
d'un des exemples prÃ©cÃ©dents :

----
$ npm test

> nodebook.chapter-05@1.0.0 test  # <1>
> mocha examples/tests.js         # <2>

app.js
  âœ“ prints a cow as a response

1 passing
----
<1> L'exÃ©cutable `npm` affiche le nom du script npm en cours d'exÃ©cution
<2> `mocha examples/tests.js` est la commande rÃ©ellement exÃ©cutÃ©e par npm

Cette fois-ci, nous avons personnalisÃ© la valeur du champ `scripts.test`
du fichier `package.json` :

[source,json,subs="+attributes"]
.package.json
----
{
  ...
  "scripts": {
    "test": "mocha examples/tests.js"
  },
  "devDependencies": {
    "mocha": "^{mochaVersion}"
  }
}
----

Nous avons eu recourt au module npm _mocha_ ([URL]#https://npmjs.com/mocha#).
De mÃªme qu'avec le <<start,script de dÃ©marrage>>, nous avons eu recourt
Ã  l'exÃ©cutable fourni par le module.
En revanche nous l'avons listÃ© dans la <<install.dev,section `devDependencies`>>
car il est relatif Ã  l'outillage du projet.

Les services d'intÃ©gration continue lancent le script `npm test`
lorsqu'ils dÃ©tectent qu'ils ont affaire Ã  un projet Node.

[NOTE]
.[RemarquePreTitre]#Documentation# Scripts dÃ©finis par npm
====
D'autres scripts que `test` et `start` sont dÃ©finis par l'exÃ©cutable `npm`.
Ils sont tous documentÃ©s sur [URL]#https://docs.npmjs.com/misc/scripts#.
====

[[run]]
=== CrÃ©er un script npm personnalisÃ©

Les scripts npm personnalisÃ©s sont utiles *lorsque nous souhaitons outiller*
notre projet sans forcÃ©ment que Ã§a soit en rapport avec le lancement des tests
ou de l'application.

Les scripts personnalisÃ©s se dÃ©marrent avec `npm run` :

----
$ npm <i>run</i> print-args

> nodebook.chapter-05@1.0.0 print-args
> node examples/print-args.js

Rien Ã  signaler.
----

Nous avons crÃ©Ã© ce script en configurant la valeur du champ `scripts.print-args`
du fichier `package.json` :

[source,json]
.package.json
----
{
  ...
  "scripts": {
    "print-args": "node examples/print-args.js"
  }
}
----

[TIP]
.[RemarquePreTitre]#Pratique# Lister les scripts disponibles
====
La commande `npm run` (sans argument) liste tous les scripts npm du projet.
====

J'ai dÃ©veloppÃ© ces conventions avec le temps :

- `npm run build` : construit les artÃ©facts Ã  dÃ©ployer ;
- `npm run deploy` : dÃ©ploie le projet vers l'hÃ©bergeur ;
- `npm run lint` : applique un vÃ©rificateur syntaxique au code du projet ;
- `npm run watch` : dÃ©marre l'application et la relance Ã  chaque changement.

[TIP]
.[RemarquePreTitre]#Pratique# Passer des arguments Ã  un script npm
====
Une option spÃ©ciale nous aide Ã  transmettre des arguments au script en question.
Les arguments doivent Ãªtre placÃ©s Ã  droite de l'option `--` :

----
$ npm run print-args un --test=true
['un']
$ npm run print-args -- un --test=true
['un', '--test=true']
----
====

Un script npm peut faire appel Ã  d'autres scripts npm :

[source,json,subs="-specialchars"]
.package.json
----
{
  ...
  "scripts": {
    "lint": "eslint ./examples",
    "test": "npm run lint <i>&&</i> mocha examples/tests.js"
  }
}
----

J'ai plutÃ´t tendance Ã  dÃ©couper mes scripts de sorte Ã  ce qu'ils fassent
tous une chose et une seule.
Je peux ainsi les appeler de maniÃ¨re individuelle pour rÃ©duire la boucle
de feedback.

[source,json,subs="-specialchars"]
.package.json
----
{
  ...
  "scripts": {
    "lint": "eslint ./examples",
    "test": "npm run lint && npm run test:unit",
    "test:unit": "mocha examples/tests.js"
  }
}
----

La section suivante va nous aider Ã  orchestrer l'exÃ©cution des scripts
les uns par rapport aux autres.

[[run-pre-post]]
=== ExÃ©cuter des commandes avant et aprÃ¨s des scripts npm

L'ordre d'exÃ©cution des scripts se contrÃ´le en utilisant les prÃ©fixes
`pre` et `post`.
Par exemple, les scripts nommÃ©s `pretest` et `posttest` seront exÃ©cutÃ©s
respectivement avant et aprÃ¨s le script `test`.

[source,json,subs="-specialchars"]
.package.json
----
{
  ...
  "scripts": {
    "lint": "eslint ./examples",
    "test": "mocha examples/tests.js",
    "<i>pre</i>test": "npm run lint"
  }
}
----

Dans cet exemple de configuration, l'exÃ©cution de la commande `npm test`
lancera d'abord le script `pretest`, puis le script `lint`
puis enfin le script `test` :

----
$ npm test

> nodebook.chapter-05@1.0.0 pretest
> npm run lint
...

> nodebook.chapter-05@1.0.0 lint
> eslint ./examples
...

> nodebook.chapter-05@1.0.0 test
> mocha examples/tests.js
...
----

Ce mÃ©canisme est utile pour s'intercaler sur des temps particuliers
du cycle de vie d'un projet node.
Voici une sÃ©lection

[format="csv", options="header", separator=";", cols="1,2,2"]
|===
Script; Quand; Pourquoi
`pretest`; Avant les tests; PrÃ©parer l'espace de travail
`posttest`; AprÃ¨s les tests; VÃ©rifier les rÃ¨gles de syntaxe de notre code
`postinstall`; AprÃ¨s installation les dÃ©pendances; PrÃ©paration significative du projet (tÃ©lÃ©chargements supplÃ©mentaires, etc.)
`prestart`; Avant de dÃ©marrer l'application; PrÃ©paratifs lÃ©gers
`prepublishOnly`; Avant de publier le module; PrÃ©paration du projet avant de le distribuer (compilation de fichiers, etc.)
|===

[[package.json]]
== Anatomie du fichier `package.json`

TBD.


[[commands]]
== Quelques commandes pour aller plus loin

Nous venons de voir les commandes les plus utilisÃ©es de l'exÃ©cutable `npm`.
D'autres commandes complÃ¨tent son utilisation.
Leur intÃ©rÃªt varie en fonction de vos envies et de vos pratiques de dÃ©veloppement.
Pas d'inquiÃ©tude donc si vous ne les utilisez pas toutes :
j'en parle pour *Ã©clairer quelques points intÃ©ressants Ã  explorer*.

[[view]]
=== `npm view` : voir les informations d'un module

La commande `npm view` est une vue synthÃ©tique d'un module npm donnÃ©.
Elle est similaire Ã  celle que nous pourrions trouver sur le registre npm
mais condensÃ©e pour l'affichage dans un terminal.

Nous y retrouvons des informations fournies par les auteurs et autrices du module
ainsi que d'autres, fournies par le registre npm.

----
$ npm view nodebook

nodebook@0.9.1 | CC-BY-NC-SA-4.0 | deps: 6 | versions: 21
Node.js â€” Apprendre par l'exemple

keywords: nodejs, book, french, livre, learn, apprendre

bin: nodebook

dist
.tarball https://registry.npmjs.org/nodebook/nodebook-0.9.1.tgz
.shasum: 5ea87e9b85782e23164705a49cb7bd2dc4063775
.integrity: sha512-...
.unpackedSize: 15.0 MB

dependencies:
finalhandler: ^1.1.1  serve-static: ^1.13.2
get-port: ^3.2.0      update-check: ^1.5.2
glob: ^7.1.2          yargs: ^11.1.0

maintainers:
- oncletom

dist-tags:
latest: 0.9.1

published 23 hours ago by oncletom
----

[horizontal]
.SÃ©lection de champs que je trouve intÃ©ressants.
`bin`::
  Indique la prÃ©sence d'un ou plusieurs <<install.global,exÃ©cutables>>.
`dist`::
  Informations Ã  propos du fichier tÃ©lÃ©chargÃ© quand
  nous faisons `npm install <module>`.
`dependencies`::
  Les modules additionnels tÃ©lÃ©chargÃ©s lors de l'installation.
`dist-tags`::
  Les Ã©tiquettes dÃ©finies par les auteurs et autrices, utiles quand nous souhaitons
  <<install.version,jongler entre diffÃ©rentes versions>> du module.

Nous pouvons aussi zoomer sur une mÃ©tadonnÃ©e.
Par exemple, le champ `dependencies` pour ne lister que les dÃ©pendances directes :

----
$ npm view nodebook dependencies
{ finalhandler: '^1.1.1',
  'get-port': '^3.2.0',
  glob: '^7.1.2',
  'serve-static': '^1.13.2',
  'update-check': '^1.5.2',
  yargs: '^11.1.0' }
----

Il est mÃªme possible de zoomer sur un niveau plus fin de mÃ©tadonnÃ©e,
avec une annotation similaire Ã  celle d'un objet ECMAScript :

[subs="-specialchars"]
----
$ npm view nodebook dist.<i>unpackedSize</i>
14985184
$ npm view nodebook dist
{ integrity:
   'sha512-...',
  shasum: '5ea87e9b85782e23164705a49cb7bd2dc4063775',
  tarball:
    'https://registry.npmjs.org/nodebook/nodebook-0.9.1.tgz',
  fileCount: 486,
  <i>unpackedSize</i>: 14985184 }
----

[[npx]]
=== `npx` : exÃ©cuter un module sans l'installer

L'<<install.global,installation globale>> est idÃ©ale pour installer un module
npm sous forme d'exÃ©cutable systÃ¨me.
On peut cependant vite arriver Ã  en installer beaucoup sans vraiment penser Ã 
les enlever quand on n'en a plus besoin.

L'exÃ©cutable `npx` (pour `npm executable`) s'installe automatiquement avec npm.
Il agit comme un raccourci en allantrÃ©cupÃ©rer le module npm dÃ©sirÃ©
et l'exÃ©cute en lui passant les arguments souhaitÃ©s.

----
$ npx cowsay Magique !
npx: installed 10 in 2.122s
 ___________
< Magique ! >
 -----------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
----

C'est l'Ã©quivalent de ces trois commandes, en quelque sorte :

----
$ npm install --global cowsay
$ cowsay Magique !
$ npm uninstall cowsay
----

[[home]]
=== `npm home` : visiter le site web d'un module

Vous vous demandez oÃ¹ trouver davantage de documentation Ã  propos d'un
module npm ?
`npm home` ouvre un nouvel onglet de navigateur et dirige ce dernier
vers sur le site web du module de votre choix.

----
$ npm home lodash
$ npm home micro
----

[[audit]]
=== `npm audit` : vÃ©rifier la sÃ©curitÃ© des dÃ©pendances

[[doctor]]
=== `npm doctor` : vÃ©rifier l'Ã©tat du systÃ¨me

`npm doctor` est une commande utilitaire qui vÃ©rifie que npm trouve
tout ce qu'il faut pour bien fonctionner.

L'exÃ©cutable `npm` inspecte le systÃ¨me Ã  la recherche de Git,
teste la connectivitÃ© vers le registre npm et s'assure qu'il a accÃ¨s en Ã©criture
Ã  des rÃ©pertoires essentiels Ã  son bon fonctionnement.

[subs="+attributes"]
----
$ npm doctor
Check                               Value
npm ping                            OK
npm -v                              v{npmVX}
node -v                             {nodeCurrentVersion}.0.0
npm config get registry             https://registry.npmjs.org
which git                           /usr/local/bin/git
Perms check on cached files         ok
Perms check on global node_modules  ok
Perms check on local node_modules   ok
Verify cache contents               verified 4066 tarballs
----

[[config]]
=== `npm config` : changer les rÃ©glages de l'exÃ©cutable `npm`

[[publish]]
=== `npm publish` : publier un module npm

----
npm notice
npm notice ğŸ“¦  asciidoctor-extension-interactive-runner@1.2.0
npm notice === Tarball Contents ===
npm notice 740B  package.json
npm notice 1.3MB demo.gif
npm notice 1.8kB index.js
npm notice 1.1kB LICENSE
npm notice 1.0kB README.md
npm notice 2.1kB src/docinfo.js
npm notice 730B  src/style.css
npm notice === Tarball Details ===
npm notice name:          asciidoctor-extension-interactive-runner
npm notice version:       1.2.0
npm notice package size:  1.2 MB
npm notice unpacked size: 1.3 MB
npm notice shasum:        c55c6f98f7817a0dc45e6bb4700d5aaa4accc002
npm notice integrity:     sha512-hVR01IMtWHhrd[...]S4OQ5IQvzm00w==
npm notice total files:   7
npm notice
+ asciidoctor-extension-interactive-runner@1.2.0
----

Parler de .npmignore et de .gitignore

[[link]]
=== `npm link` : utiliser une dÃ©pendance qui n'a pas encore Ã©tÃ© publiÃ©e

[[questions]]
== Questions et mystÃ¨res autour de npm

L'exÃ©cutable `npm` et le registre du mÃªme nom ont accompagnÃ© Node quasiment
depuis le dÃ©but.
Il paraÃ®t simple de prime abord et je pense que c'est normal de se sentir
surprisÂ·e par ses rÃ©sultats.

Passons en revue des critiques ou questionnements que j'entends rÃ©guliÃ¨rement
afin d'y voir plus clair.

[[npm.update]]
=== Quand mettre Ã  jour l'exÃ©cutable npm ?

L'exÃ©cutable `npm` est mis Ã  jour rÃ©guliÃ¨rement.
Un message s'affiche dans notre terminal lorsque nous l'utilisons et qu'il
dÃ©tecte qu'une version plus rÃ©cente est disponible.

[subs="+attributes"]
----
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚                                     â”‚
â”‚   Update available 6.0.0 â†’ {npmvX}    â”‚
â”‚     Run npm i -g npm to update      â”‚
â”‚                                     â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
----

Le module qui contient l'exÃ©cutable `npm` suit le principe de
<<semver,versions sÃ©mantiques>>.
Ainsi, la mise Ã  jour sera sans effort si le numÃ©ro majeur de la
nouvelle version reste le mÃªme.

J'ai tendance Ã  regarder du cÃ´tÃ© de [URL]#https://github.com/npm/npm/releases#
pour lire tous les _Breaking Changes_ et comprendre en quoi la mise Ã  jour
majeure m'affecte.

[[package-lock]]
=== Je ne vois pas l'intÃ©rÃªt du fichier `package-lock.json`

Le fichier `package-lock.json` est crÃ©Ã© automatiquement par l'exÃ©cutable `npm`
dÃ¨s que vous ajoutez votre premiÃ¨re dÃ©pendance Ã  un projet.

Jetons un Å“il Ã  son contenu pour tenter d'en cerner les contours :

----
{
  "name": "nodebook.chapter-05",
  "version": "1.0.0",
  "lockfileVersion": 1,
  "requires": true,
  "dependencies": {
    "acorn": {
      "version": "5.6.1",
      "resolved":
        "https://registry.npmjs.org/acorn/-/acorn-5.6.1.tgz",
      "integrity": "sha512-...",
      "dev": true
    },
    "cowsay": {
      "version": "1.3.0",
      "resolved":
        "https://registry.npmjs.org/cowsay/-/cowsay-1.3.0.tgz",
      "integrity": "sha512-...",
      "requires": {
        "get-stdin": "^5.0.1",
        "optimist": "~0.6.1",
        "string-width": "~2.1.1",
        "strip-eof": "^1.0.0"
      }
    },
    ...
  }
}
----

Il ressemble beaucoup au fichier `package.json`.
On notera qu'il contient exclusivement des donnÃ©es liÃ©es aux dÃ©pendances
ainsi que *toutes les dÃ©pendances des dÃ©pendances*.

Si le fichier `package.json` contient une <<semver,version sÃ©mantique>>,
celui **contient la version exacte** de chaque dÃ©pendance ainsi que deux
autres types d'informations : l'URL de tÃ©lÃ©chargement et une signature
qui permet de vÃ©rifier si le fichier tÃ©lÃ©charger est le bon (intÃ©gritÃ©).

La reprÃ©sentation complÃ¨te de l'arbre de dÃ©pendances dans le fichier `package-lock.json`
traduit deux intentions :
rendre l'installation des dÃ©pendances possibles en se basant uniquement sur
ce fichier et accÃ©lÃ©rer le processus d'installation.

Avantages::
  - Le projet s'installe encore plus rapidement grÃ¢ce Ã  la commande `npm ci`.
  - Nous pouvons reproduire la mÃªme installation sur plusieurs ordinateurs.
  - La commande `npm install` installe plus rapidement en prÃ©sence d'un fichier `package-lock.json`.
InconvÃ©nients::
  - Nous devons vÃ©rifier manuellement s'il y a des patchs Ã  coup de `npm outdated` et de `npm update`.
  - Ã‡a fait un truc de plus Ã  apprendre mÃªme si on n'a pas l'impression de l'utiliser.

[[bower]]
=== npm c'est pour le backend et bower pour le frontend

_bower_ ([URL]#https://bower.io#) est un gestionnaire de modules
spÃ©cialisÃ© dans le dÃ©veloppement frontend.

Je pense que _bower_ Ã©tait utile Ã  une Ã©poque oÃ¹ l'outillage frontend disponible
dans Node Ã©tait encore confidentiel.
Je pense aussi que cette Ã©poque est rÃ©volue, au sens oÃ¹ l'outillage dÃ©diÃ© Ã 
Node et aux navigateurs web tend Ã  se confondre.

En apprenant JavaScript, Node et npm, nous gagnons non seulement un outillage
disponible immÃ©diatement mais aussi la capacitÃ© Ã  crÃ©er le nÃ´tre.
Pour en savoir plus sur comment dÃ©velopper pour le frontend comme on dÃ©veloppe
pour Node, je vous invite Ã  lire le <<../chapter-09/index.adoc#,chapitre 9>>.

Avantages::
  - On peut installer un projet sans qu'il possÃ¨de un fichier `package.json`.
  - On n'a pas nÃ©cesairement besoin de s'outiller pour utiliser les modules bower.
InconvÃ©nients::
  - Si on utilise dÃ©jÃ  un fichier `package.json` pour d'autres besoins, autant l'utiliser pour les dÃ©pendances frontend, autant utiliser npm.
  - Le dÃ©veloppement de bower stagne depuis 2015 et je pense que le projet sera arrÃªtÃ© tÃ´t ou tard.

=== Est-ce que je dois versionner le rÃ©pertoire `node_modules` ?

Le contenu du rÃ©pertoire `node_modules` se recrÃ©e automatiquement
en utilisant l'exÃ©cutable `npm`, que Ã§a soit avec la
<<install,commande `npm install`>> ou la <<update,commande `npm update`>>.
Mieux vaut versionner les fichiers `package.json` et
<<package-lock,`package-lock.json`>> pour Ãªtre certainÂ·e
de les recrÃ©er comme il faut.

Le rÃ©pertoire `node_modules` n'a donc pas besoin d'Ãªtre versionnÃ©.
Je vous encourage Ã  *ajouter `node_modules` dans le fichier `.gitignore`*.
Ce fichier texte se situe en gÃ©nÃ©ral Ã  la racine de votre projet.

Avantages::
  - Je n'en vois pas.
InconvÃ©nients::
  - Difficile Ã  versionner avec Git en cas de conflit.
  - Ã‡a va exploser si deux personnes utilisent des systÃ¨mes d'exploitation diffÃ©rents â€” certaines dÃ©pendances gÃ©nÃ¨rent des fichiers en fonction du systÃ¨me.
  - Ã‡a va exploser s'il manque un module quelque part â€” et Ã§a sera un problÃ¨me plus Ã  rÃ©gler que de _ne pas_ versionner ce rÃ©pertoire.

[[yarn]]
=== Il paraÃ®t que Yarn, c'est mieux

L'application _yarn_ ([URL]#https://yarnpkg.com#) se veut Ãªtre une alternative
Ã  l'exÃ©cutable `npm`.
Le programme vise une installation rapide, hors-ligne et sÃ©curisÃ©e.

npm rattrape rÃ©guliÃ¨rement les fonctionnalitÃ©s qui "donnent de l'avance" Ã  _yarn_.
Le choix tient donc plutÃ´t du goÃ»t ou de l'idÃ©ologie.
Essayez donc _yarn_ et gardez-le pour les bonnes raisons â€” les vÃ´tres.

Avantages::
  - Le mode _workspace_ permet de lier plusieurs projets entre eux de maniÃ¨re dÃ©clarative.
InconvÃ©nients::
  - Il faudra quand mÃªme savoir comment fonctionne npm pour les projets qui n'utilisent pas _yarn_.

[[all-your-base-are-belong-to-us]]
=== npm est lent, il installe la moitiÃ© d'Internet Ã  chaque fois

L'exÃ©cutable `npm` passe le plus clair de son temps Ã  faire des aller-retours
vers le registre npm en utilisant votre connexion Internet.
Il tÃ©lÃ©chargera un module seulement s'il ne l'a pas dÃ©jÃ  tÃ©lÃ©chargÃ© Ã  une autre
reprise, sur un autre projet.

L'Ã©quipe de dÃ©veloppement de l'exÃ©cutable `npm` travaille Ã  amÃ©liorer
ses performances et sa qualitÃ© d'utilisation.
Cette Ã©quipe n'a pas d'influence sur les choix faits par les autrices et auteurs
de modules npm.

Le temps de tÃ©lÃ©chargement d'un module npm dÃ©pend de deux choses :
du *nombre de dÃ©pendances* Ã  installer et de leur *poids respectif*.
Le poids d'un module correspond Ã  la somme du poids de chaque script et
des ressources additionnelles (images, documentation, etc). +
Dans les deux cas, *plus il y'en a, plus Ã§a prendra de temps Ã  installer*.

Par exemple, le seul ajout de _webpack 4_ ([URL]#https://npmjs.com/webpack#)
augmente le coÃ»t de tÃ©lÃ©chargement de 14Mo lors de `npm install`.
Ce n'est pas rien et ce n'est certainement pas la faute Ã  l'exÃ©cutable `npm`.

Le service en ligne _Package Phobia_ ([URL]#https://packagephobia.now.sh#)
garde un historique du poids des modules npm.
Celui de _webpack_ se trouve sur
[URL]#https://packagephobia.now.sh/result?p=webpack#.

.CoÃ»t d'installation du module npm _webpack_ (en vert foncÃ©) et de ses dÃ©pendances (en vert clair).
image::images/module-content.png[]


[TIP]
.[RemarquePreTitre]#Pratique# ConnaÃ®tre le coÃ»t des dÃ©pendances de son projet
====
Le module npm _cost-of-modules_ ([URL]#https://npmjs.com/cost-of-modules#)
calcule la quantitÃ© et le poids des dÃ©pendances listÃ©es
dans un fichier `package.json`.

Pratique pour identifier quel module remplacer par un autre, plus lÃ©ger et donc
plus rapide Ã  installer.

----
$ npx cost-of-modules               # <1>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ name      â”‚ children    â”‚ size  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ lodash    â”‚ 0           â”‚ 1.34M â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ micro     â”‚ 19          â”‚ 0.67M â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cowsay    â”‚ 9           â”‚ 0.22M â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3 modules â”‚ 28 children â”‚ 2.22M â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
----
<1> La <<npx,commande `npx`>> est un raccourci pour exÃ©cuter des modules npm sans les installer.
====


[[errors]]
=== Que signifient les erreurs affichÃ©es pendant `npm install` ?

L'exÃ©cutable `npm` est gÃ©nÃ©reux en messages pendant l'installation
de modules.
C'est parfois difficile Ã  lire, notamment pour comprendre la raison du message
et la solution Ã  apporter.

Si `npm WARN` s'affiche, ce n'est pas une erreur mais un message
Ã  caractÃ¨re informatif. +
Si `npm ERR` dÃ©bute la ligne, il y a un problÃ¨me sur lequel nous
avons une action immÃ©diate Ã  mener.

[[error-deprecated]]
==== Module dÃ©prÃ©ciÃ©

Un module est dÃ©prÃ©ciÃ© quand il n'est plus maintenu par ses auteurs ou autrices,
s'il est dÃ©veloppÃ© sous un nouveau nom ou si nous sommes encouragÃ©Â·eÂ·s Ã 
<<install.version,faire une mise Ã  jour majeure>>.

Un module dÃ©prÃ©ciÃ© ne nous regarde pas sauf s'il est listÃ© dans le champ
`dependencies` ou `devDependencies` d'un fichier `package.json`.

[subs="-specialchars"]
.Exemple d'encouragements Ã  utiliser un autre module.
----
npm WARN deprecated babel-preset-es2017@6.24.1:
  Thanks for using Babel: <i>we recommend using babel-preset-env</i>
  now: please read babeljs.io/env to update!

npm WARN deprecated babel-preset-babili@0.0.10: babili has
  been <i>renamed to babel-minify</i>.
  Please update to babel-preset-minify
----

[subs="-specialchars"]
.Exemple de module qui n'est plus maintenu.
----
npm WARN deprecated nomnom@1.6.2: <i>Package no longer supported</i>.
  Contact support@npmjs.com for more info.
----

Un module qui n'est plus maintenu ne recevra probalement plus de mises Ã  jour.
Il vaut mieux dans ce cas en trouver un autre qui fait plus ou moins la mÃªme chose.

[[error-skipping]]
==== ProblÃ¨me avec une dÃ©pendance optionnelle

Certains modules effectuent une opÃ©ration de compilation : une partie de leur
code source est Ã©crit dans un autre langage que l'ECMAScript et ils
font en sorte de crÃ©er un pont avec Node.

Il arrive que l'opÃ©ration de compilation n'aboutisse pas pour diverses raisons
â€” il manque un logiciel, incompatibilitÃ© avec le systÃ¨me d'exploitation
ou avec l'architecture du CPU.

Le fait qu'il y ait marquÃ© `SKIPPING` et `OPTIONAL` me laisse penser
que ce n'est pas grave si l'opÃ©ration ne se passe pas comme prÃ©vu.

----
npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@1.1.3
npm WARN notsup SKIPPING OPTIONAL DEPENDENCY:
  Unsupported platform for fsevents@1.1.3:
  wanted {"os":"darwin","arch":"any"}
  (current: {"os":"win32","arch":"x64"})
----

[[error-404]]
==== Module introuvable

Le module que vous cherchez Ã  installer n'existe pas.
Il s'agit peut-Ãªtre d'une erreur de frappe ou alors le module a Ã©tÃ© retirÃ©
de la circulation.

----
$ npm i aria-roless
npm ERR! code E404
npm ERR! 404 Not Found: aria-roless@latest
----

[[error-crlf]]
==== CaractÃ¨re de fin de ligne sous Windows

Les anciennes versions de npm avaient du mal Ã  concilier les caractÃ¨res de fin
de ligne sous Windows (`\r\n`), caractÃ¨re diffÃ©rent des autres systÃ¨mes Linux (`\n`).

----
npm error Expected linebreaks to be 'LF' but
  found 'CRLF' linebreak-style
----

<<npm.update,Mettez Ã  jour npm>> vers une version plus rÃ©cente pour
rÃ©gler le problÃ¨me.

[[error-pkg]]
==== Fichier `package.json` incomplet

Les messages suivants s'affichent quand les champs `description` et
`repository` manquent Ã  l'appel de notre fichier `package.json`.

----
npm WARN tmp@1.0.0 No description
npm WARN tmp@1.0.0 No repository field.
----

RÃ©ferrez-vous Ã  la section <<package.json,anatomie du fichier `package.json`>>
pour savoir comment remplir ces champs manquants.

[[error-peer-dependency]]
==== DÃ©pendance complÃ©mentaire Ã  installer

Certains modules nÃ©cessitent un ou plusieurs modules complÃ©mentaires pour
fonctionner.
Toutefois ces modules complÃ©mentaires sont Ã  installer manuellement.
C'est la signification du message d'erreur suivant.

[subs="-specialchars"]
----
npm WARN <i>react-power-picture</i>@1.0.0 <i>requires</i> a peer of
  <i>react</i>@^15.0.0-0 || ^16.0.0-0 but none is installed.
  You must install peer dependencies yourself.
----

L'exemple prÃ©cÃ©dent laisse Ã  penser que nous avons installÃ© le module npm
_react-power-picture_.
L'installation du module signale que le module npm complÃ©mentaire _react_
est nÃ©cessaire mais que nous ne l'avons pas installÃ©.

Si c'est quelque chose qui vous parle, installez alors _react_
avec `npm install react`. +

Si vous pensez que c'est une erreur ou une incomprÃ©hension, dÃ©sinstallez
le module et cherchez une alternative.
Ã‡a se produit gÃ©nÃ©ralement quand on n'aperÃ§oit pas qu'un module est dÃ©diÃ©
Ã  un certain framework â€” et qu'on ne veut pas utiliser ce framework.

== Conclusion

TBD.
